<div class="container-fluid">
  <!-- 페이지 헤더 -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="d-flex justify-content-between align-items-center">
        <h2><i class="bi bi-file-text me-2"></i>계약 관리</h2>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="/">홈</a></li>
            <li class="breadcrumb-item active">계약 관리</li>
          </ol>
        </nav>
      </div>
    </div>
  </div>

  <!-- 통계 카드 -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm border-primary">
        <div class="card-body text-center">
          <h6 class="text-muted mb-2">전체 계약</h6>
          <h3 class="mb-0 text-primary"><%= stats.total.toLocaleString() %>건</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-danger">
        <div class="card-body text-center">
          <h6 class="text-muted mb-2">최종계약체결</h6>
          <h3 class="mb-0 text-danger"><%= stats.contracted.toLocaleString() %>건</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-warning">
        <div class="card-body text-center">
          <h6 class="text-muted mb-2">진행 중</h6>
          <h3 class="mb-0 text-warning"><%= stats.ongoing.toLocaleString() %>건</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-success">
        <div class="card-body text-center">
          <h6 class="text-muted mb-2">총 계약금액</h6>
          <h3 class="mb-0 text-success"><%= (stats.totalAmount / 100000000).toFixed(1) %>억원</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- 필터링 및 검색 섹션 -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card shadow">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>필터 및 검색</h5>
        </div>
        <div class="card-body">
          <form method="GET" action="/contracts" id="filterForm">
            <div class="row g-3">
              <!-- 게임사 검색 -->
              <div class="col-md-3">
                <label class="form-label">게임사</label>
                <select class="form-select" name="company" id="companyFilter">
                  <option value="">전체</option>
                  <% companies.forEach(company => { %>
                    <option value="<%= company %>" <%= filters.companyName === company ? 'selected' : '' %>>
                      <%= company %>
                    </option>
                  <% }); %>
                </select>
              </div>

              <!-- 진행상황 -->
              <div class="col-md-2">
                <label class="form-label">진행상황</label>
                <select class="form-select" name="status">
                  <option value="">전체</option>
                  <% statuses.forEach(status => { %>
                    <option value="<%= status %>" <%= filters.status === status ? 'selected' : '' %>>
                      <%= status %>
                    </option>
                  <% }); %>
                </select>
              </div>

              <!-- 업무상태 -->
              <div class="col-md-3">
                <label class="form-label">업무상태</label>
                <select class="form-select" name="work_status">
                  <option value="">전체</option>
                  <% workStatuses.forEach(ws => { %>
                    <option value="<%= ws %>" <%= filters.workStatus === ws ? 'selected' : '' %>>
                      <%= ws %>
                    </option>
                  <% }); %>
                </select>
              </div>

              <!-- 선정 협력사 -->
              <div class="col-md-3">
                <label class="form-label">선정 협력사</label>
                <select class="form-select" name="vendor">
                  <option value="">전체</option>
                  <% vendors.forEach(vendor => { %>
                    <option value="<%= vendor %>" <%= filters.selectedVendor === vendor ? 'selected' : '' %>>
                      <%= vendor %>
                    </option>
                  <% }); %>
                </select>
              </div>

              <!-- 담당PM -->
              <div class="col-md-3">
                <label class="form-label">담당PM</label>
                <select class="form-select" name="manager_id">
                  <option value="">전체</option>
                  <% managers.forEach(manager => { %>
                    <option value="<%= manager.id %>" <%= filters.managerId == manager.id ? 'selected' : '' %>>
                      <%= manager.name %>
                    </option>
                  <% }); %>
                </select>
              </div>

              <!-- 버튼 -->
              <div class="col-md-3 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-primary flex-fill">
                  <i class="bi bi-search me-1"></i>검색
                </button>
                <a href="/contracts" class="btn btn-secondary">
                  <i class="bi bi-arrow-clockwise"></i>
                </a>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- 계약 목록 테이블 -->
  <div class="row">
    <div class="col-md-12">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-list-ul me-2"></i>계약 목록 
            <span class="badge bg-light text-dark"><%= contracts.length %>건</span>
          </h5>
        </div>
        <div class="card-body p-0">
          <% if (contracts && contracts.length > 0) { %>
            <div class="table-responsive">
              <table class="table table-hover table-sm mb-0" id="contractsTable">
                <thead class="table-light sticky-top">
                  <tr>
                    <th style="width: 3%;" class="text-center sortable" data-sort="contract_id">
                      번호
                      <i class="bi bi-arrow-down-up sort-icon"></i>
                    </th>
                    <th style="width: 9%;" class="sortable" data-sort="company_name">
                      게임사
                      <i class="bi bi-arrow-down-up sort-icon"></i>
                    </th>
                    <th style="width: 7%;" class="sortable" data-sort="manager_name">
                      담당PM
                      <i class="bi bi-arrow-down-up sort-icon"></i>
                    </th>
                    <th style="width: 10%;" class="sortable" data-sort="service_category">
                      서비스 부문
                      <i class="bi bi-arrow-down-up sort-icon"></i>
                    </th>
                    <th style="width: 15%;" class="sortable" data-sort="service_request">
                      서비스 요청명
                      <i class="bi bi-arrow-down-up sort-icon"></i>
                    </th>
                    <th style="width: 7%;" class="text-center sortable" data-sort="work_start_date">
                      계약시작일
                      <i class="bi bi-arrow-down-up sort-icon"></i>
                    </th>
                    <th style="width: 7%;" class="text-center sortable" data-sort="work_end_date">
                      계약종료일
                      <i class="bi bi-arrow-down-up sort-icon"></i>
                    </th>
                    <th style="width: 7%;" class="text-center sortable" data-sort="status">
                      진행상황
                      <i class="bi bi-arrow-down-up sort-icon"></i>
                    </th>
                    <th style="width: 9%;" class="sortable" data-sort="selected_vendor">
                      선정 협력사
                      <i class="bi bi-arrow-down-up sort-icon"></i>
                    </th>
                    <th style="width: 8%;" class="text-end sortable" data-sort="contract_amount">
                      계약금액
                      <i class="bi bi-arrow-down-up sort-icon"></i>
                    </th>
                    <th style="width: 6%;" class="text-center sortable" data-sort="work_status">
                      업무상태
                      <i class="bi bi-arrow-down-up sort-icon"></i>
                    </th>
                    <th style="width: 15%;">메모</th>
                  </tr>
                </thead>
                <tbody>
                  <% contracts.forEach((contract, index) => { %>
                    <tr class="contract-row" style="cursor: pointer;" data-contract-id="<%= contract.contract_id %>">
                      <td class="text-center"><%= contract.contract_id %></td>
                      <td>
                        <a href="/games/<%= encodeURIComponent(contract.company_name) %>" class="text-decoration-none">
                          <%= contract.company_name %>
                        </a>
                      </td>
                      <td>
                        <% if (contract.manager_name) { %>
                          <span class="badge bg-info text-dark" title="<%= contract.manager_email %>">
                            <%= contract.manager_name %>
                          </span>
                        <% } else { %>
                          <span class="text-muted">-</span>
                        <% } %>
                      </td>
                      <td><%= contract.service_category || '-' %></td>
                      <td class="text-truncate" style="max-width: 200px;" title="<%= contract.service_request %>">
                        <%= contract.service_request || '-' %>
                      </td>
                      <td class="text-center"><%= contract.work_start_date || '-' %></td>
                      <td class="text-center"><%= contract.work_end_date || '-' %></td>
                      <td class="text-center">
                        <span class="badge <%= 
                          contract.status === '견적요청' ? 'bg-primary' : 
                          contract.status === '견적서 제출' ? 'bg-success' : 
                          contract.status === '선정완료' ? 'bg-warning text-dark' : 
                          contract.status === '계약완료' ? 'bg-info' : 
                          contract.status === '최종계약체결' ? 'bg-danger' : 
                          contract.status === '계약종료(정산)' ? 'bg-secondary' : 'bg-light text-dark'
                        %>">
                          <%= contract.status || '-' %>
                        </span>
                      </td>
                      <td><%= contract.selected_vendor || '-' %></td>
                      <td class="text-end">
                        <% if (contract.contract_amount && contract.selected_vendor) { %>
                          <%= contract.contract_amount %>
                        <% } else { %>
                          -
                        <% } %>
                      </td>
                      <td class="text-center">
                        <% if (contract.work_status) { %>
                          <span class="badge <%= 
                            contract.work_status === '진행 중' ? 'bg-warning text-dark' : 
                            contract.work_status === '업무 종료' ? 'bg-secondary' : 'bg-light text-dark'
                          %>">
                            <%= contract.work_status %>
                          </span>
                        <% } else { %>
                          -
                        <% } %>
                      </td>
                      <td class="memo-cell" data-contract-id="<%= contract.id %>">
                        <div class="memo-display" style="<%= contract.memo ? '' : 'color: #999;' %>">
                          <%= contract.memo || '메모를 입력하려면 클릭하세요' %>
                        </div>
                        <input type="text" class="form-control form-control-sm memo-input" 
                               value="<%= contract.memo || '' %>" 
                               placeholder="메모 입력..." 
                               style="display: none;">
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="alert alert-info m-4">
              <i class="bi bi-info-circle me-2"></i>검색 조건에 맞는 계약 정보가 없습니다.
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 스타일 추가 -->
<style>
  .contract-row:hover {
    background-color: #f8f9fa;
  }
  
  .sticky-top {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: white;
  }
  
  .card {
    border-radius: 8px;
  }
  
  .card-header {
    border-radius: 8px 8px 0 0;
  }
  
  .text-truncate {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .table tbody tr {
    transition: background-color 0.2s ease;
  }
  
  /* 정렬 가능한 헤더 스타일 */
  .sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 25px !important;
  }
  
  .sortable:hover {
    background-color: #e9ecef;
  }
  
  .sort-icon {
    font-size: 0.9rem;
    color: #6c757d;
    margin-left: 5px;
    opacity: 0.4;
  }
  
  .sortable.active .sort-icon {
    opacity: 1;
    color: #0d6efd;
    font-weight: bold;
  }
  
  .sortable.active.asc .bi-arrow-down-up:before {
    content: "\f13A"; /* bi-arrow-up-circle-fill */
  }
  
  .sortable.active.desc .bi-arrow-down-up:before {
    content: "\f119"; /* bi-arrow-down-circle-fill */
  }
  
  /* 메모 셀 스타일 */
  .memo-cell {
    cursor: text;
    padding: 8px !important;
  }
  
  .memo-display {
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    min-height: 30px;
    transition: background-color 0.2s;
  }
  
  .memo-display:hover {
    background-color: #f8f9fa;
  }
  
  .memo-input {
    width: 100%;
  }
  
  .memo-cell.editing .memo-display {
    display: none;
  }
  
  .memo-cell.editing .memo-input {
    display: block !important;
  }
</style>

<!-- JavaScript -->
<script>
  // 현재 정렬 상태
  const currentSortBy = '<%= sortBy %>';
  const currentSortOrder = '<%= sortOrder %>';
  
  // 페이지 로드 시 현재 정렬 상태 표시
  document.addEventListener('DOMContentLoaded', function() {
    const activeHeader = document.querySelector(`th.sortable[data-sort="${currentSortBy}"]`);
    if (activeHeader) {
      activeHeader.classList.add('active');
      activeHeader.classList.add(currentSortOrder.toLowerCase());
    }
  });
  
  // 정렬 헤더 클릭 이벤트
  document.querySelectorAll('th.sortable').forEach(header => {
    header.addEventListener('click', function() {
      const sortField = this.getAttribute('data-sort');
      let newSortOrder = 'DESC';
      
      // 같은 컬럼을 다시 클릭하면 정렬 순서 토글
      if (sortField === currentSortBy) {
        newSortOrder = currentSortOrder === 'DESC' ? 'ASC' : 'DESC';
      }
      
      // URL 파라미터 생성
      const urlParams = new URLSearchParams(window.location.search);
      urlParams.set('sort_by', sortField);
      urlParams.set('sort_order', newSortOrder);
      
      // 페이지 이동
      window.location.href = `${window.location.pathname}?${urlParams.toString()}`;
    });
  });
  
  // 테이블 행 클릭 시 게임사 페이지로 이동
  document.querySelectorAll('.contract-row').forEach(row => {
    row.addEventListener('click', function(e) {
      // 링크 클릭은 제외
      if (e.target.tagName === 'A') return;
      
      const companyName = this.querySelector('td:nth-child(2) a').textContent.trim();
      window.location.href = `/games/${encodeURIComponent(companyName)}`;
    });
  });
  
  // 자동 제출 기능 (필터 변경 시)
  const filterSelects = document.querySelectorAll('#filterForm select, #filterForm input[type="date"]');
  filterSelects.forEach(select => {
    select.addEventListener('change', function() {
      document.getElementById('filterForm').submit();
    });
  });
  
  // 메모 기능
  document.querySelectorAll('.memo-cell').forEach(cell => {
    const display = cell.querySelector('.memo-display');
    const input = cell.querySelector('.memo-input');
    const contractId = cell.getAttribute('data-contract-id');
    
    // 메모 표시 영역 클릭 시 편집 모드로 전환
    display.addEventListener('click', function(e) {
      e.stopPropagation(); // 행 클릭 이벤트 방지
      cell.classList.add('editing');
      input.focus();
      input.select();
    });
    
    // 입력 필드에서 포커스 잃을 때 저장
    input.addEventListener('blur', function() {
      saveMemo(cell, contractId, input.value);
    });
    
    // Enter 키로 저장
    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        input.blur();
      }
    });
    
    // ESC 키로 취소
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        e.preventDefault();
        input.value = display.textContent.trim();
        if (input.value === '메모를 입력하려면 클릭하세요') {
          input.value = '';
        }
        cell.classList.remove('editing');
      }
    });
    
    // 입력 필드 클릭 시 이벤트 전파 방지
    input.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  });
  
  // 메모 저장 함수
  function saveMemo(cell, contractId, memo) {
    const display = cell.querySelector('.memo-display');
    const input = cell.querySelector('.memo-input');
    const originalMemo = display.textContent.trim();
    const originalValue = originalMemo === '메모를 입력하려면 클릭하세요' ? '' : originalMemo;
    
    // 변경사항이 없으면 그냥 편집 모드 종료
    if (memo === originalValue) {
      cell.classList.remove('editing');
      return;
    }
    
    // 저장 중 표시
    display.textContent = '저장 중...';
    display.style.color = '#999';
    
    // API 호출
    fetch('/contracts/update-memo', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        contractId: contractId,
        memo: memo
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // 성공 시 표시 업데이트
        display.textContent = memo || '메모를 입력하려면 클릭하세요';
        display.style.color = memo ? '' : '#999';
        input.value = memo;
        
        // 잠깐 성공 표시
        const originalBg = cell.style.backgroundColor;
        cell.style.backgroundColor = '#d4edda';
        setTimeout(() => {
          cell.style.backgroundColor = originalBg;
        }, 500);
      } else {
        alert('메모 저장 실패: ' + data.message);
        display.textContent = originalValue || '메모를 입력하려면 클릭하세요';
        display.style.color = originalValue ? '' : '#999';
      }
      cell.classList.remove('editing');
    })
    .catch(error => {
      console.error('메모 저장 오류:', error);
      alert('메모 저장 중 오류가 발생했습니다.');
      display.textContent = originalValue || '메모를 입력하려면 클릭하세요';
      display.style.color = originalValue ? '' : '#999';
      cell.classList.remove('editing');
    });
  }
</script>

