<div class="row mb-4">
  <div class="col-md-12">
    <div class="card shadow">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><%= companyName %> ê²Œì„ í¬ì¸íŠ¸ í˜„í™©</h5>
      </div>
      <div class="card-body">
        <% if (userRole === 'ë‹´ë‹¹ì') { %>
        <div class="alert alert-info mb-3">
          <i class="bi bi-info-circle-fill me-2"></i> í˜„ì¬ ì‚¬ìš©ìì˜ ì—­í• ì€ <strong>ë‹´ë‹¹ì</strong>ì…ë‹ˆë‹¤. ë‹´ë‹¹í•˜ê³  ìˆëŠ” ê²Œì„ì‚¬ì˜ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
        <% } %>
        
        <div class="row mb-4">
          <div class="col-lg-8">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title text-center mb-4">í¬ì¸íŠ¸ í˜„í™©</h5>
                
                <!-- í¬ì¸íŠ¸ ì‚¬ìš©ëŸ‰ ì§„í–‰ë¥  ë°” -->
                <div class="mb-4">
                  <% 
                    // ìš°ìˆ˜í¬ì¸íŠ¸ ê³„ì‚°
                    let totalExcellentPointsForProgress = 0;
                    if (gamesWithUsage && gamesWithUsage.length > 0) {
                      totalExcellentPointsForProgress = gamesWithUsage.reduce((sum, game) => sum + (game.excellentPoints || 0), 0);
                    }
                    
                    const totalAvailable = totalBasePoints + totalSelfPoints + totalExcellentPointsForProgress;
                    
                    // ì „ì²´ ì‚¬ìš©ë¥ ì€ ì´ ê³„ì•½ ê¸ˆì•¡(ìë¶€ë‹´/ê¸°ë³¸ êµ¬ë¶„ ì—†ì´)ì„ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
                    const totalContractUsed = typeof totalContractAmount !== 'undefined' ? totalContractAmount : 0;
                    const usagePercent = totalAvailable > 0 ? (totalContractUsed / totalAvailable * 100) : 0;
                    
                    let progressClass = 'bg-success';
                    if (usagePercent > 80) progressClass = 'bg-danger';
                    else if (usagePercent > 60) progressClass = 'bg-warning';
                    
                    const remainingPoints = totalAvailable - totalContractUsed;
                  %>
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">ì „ì²´ ì‚¬ìš©ë¥ </h6>
                    <small class="text-muted">
                      <%= totalContractUsed.toLocaleString() %> P / <%= totalAvailable.toLocaleString() %> P
                    </small>
                  </div>
                  <div class="progress mb-2" style="height: 12px;">
                    <div class="progress-bar <%= progressClass %>" 
                         style="width: <%= Math.min(usagePercent, 100) %>%;"
                         aria-valuenow="<%= usagePercent %>" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                      <%= usagePercent.toFixed(1) %>%
                    </div>
                  </div>
                  <div class="text-center">
                    <span class="badge bg-info">
                      ë‚¨ì€ í¬ì¸íŠ¸: <%= remainingPoints.toLocaleString() %> P
                    </span>
                  </div>
                </div>

                <!-- í¬ì¸íŠ¸ ìƒì„¸ ì •ë³´ -->
                <div class="row">
                  <div class="col-md-3">
                    <div class="card bg-light">
                      <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2 text-muted">ê¸°ë³¸ í¬ì¸íŠ¸</h6>
                        <h4 class="card-text"><%= totalBasePoints.toLocaleString() %> P</h4>
                        <% if (totalUsageData && totalUsageData.base > 0) { %>
                        <small class="text-muted">ì‚¬ìš©: <%= totalUsageData.base.toLocaleString() %> P</small>
                        <% } %>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="card bg-light">
                      <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2 text-muted">ìë¶€ë‹´ í¬ì¸íŠ¸</h6>
                        <h4 class="card-text"><%= totalSelfPoints.toLocaleString() %> P</h4>
                        <% if (totalUsageData && totalUsageData.self > 0) { %>
                        <small class="text-muted">ì‚¬ìš©: <%= totalUsageData.self.toLocaleString() %> P</small>
                        <% } %>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="card bg-warning">
                      <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2 text-dark">ìš°ìˆ˜ í¬ì¸íŠ¸</h6>
                        <% 
                          let totalExcellentPoints = 0;
                          let totalExcellentUsed = 0;
                          if (gamesWithUsage && gamesWithUsage.length > 0) {
                            totalExcellentPoints = gamesWithUsage.reduce((sum, game) => sum + (game.excellentPoints || 0), 0);
                            totalExcellentUsed = gamesWithUsage.reduce((sum, game) => sum + (game.pointsUsed.excellent || 0), 0);
                          }
                        %>
                        <h4 class="card-text text-dark"><%= totalExcellentPoints.toLocaleString() %> P</h4>
                        <% if (totalExcellentUsed > 0) { %>
                        <small class="text-dark">ì‚¬ìš©: <%= totalExcellentUsed.toLocaleString() %> P</small>
                        <% } %>
                        
                        <!-- ìš°ìˆ˜ê²Œì„ì‚¬ í† ê¸€ (ì–´ë“œë¯¼ë§Œ) -->
                        <% if (userRole === 'ì–´ë“œë¯¼') { %>
                        <div class="mt-2">
                          <div class="d-flex justify-content-center gap-1">
                            <% 
                              let hasExcellent1st = false, hasExcellent2nd = false, hasExcellent3rd = false;
                              if (gamesWithUsage && gamesWithUsage.length > 0) {
                                hasExcellent1st = gamesWithUsage.some(game => game.isExcellent1st);
                                hasExcellent2nd = gamesWithUsage.some(game => game.isExcellent2nd);
                                hasExcellent3rd = gamesWithUsage.some(game => game.isExcellent3rd);
                              }
                            %>
                            <button class="btn btn-sm <%= hasExcellent1st ? 'btn-success' : 'btn-outline-secondary' %>" 
                                    onclick="toggleExcellentCompany('1st')" 
                                    title="1ì°¨ ìš°ìˆ˜ê²Œì„ì‚¬">
                              ğŸ¥‡
                            </button>
                            <button class="btn btn-sm <%= hasExcellent2nd ? 'btn-success' : 'btn-outline-secondary' %>" 
                                    onclick="toggleExcellentCompany('2nd')" 
                                    title="2ì°¨ ìš°ìˆ˜ê²Œì„ì‚¬">
                              ğŸ¥ˆ
                            </button>
                            <button class="btn btn-sm <%= hasExcellent3rd ? 'btn-success' : 'btn-outline-secondary' %>" 
                                    onclick="toggleExcellentCompany('3rd')" 
                                    title="3ì°¨ ìš°ìˆ˜ê²Œì„ì‚¬">
                              ğŸ¥‰
                            </button>
                          </div>
                          <small class="text-dark d-block mt-1">ìš°ìˆ˜ê²Œì„ì‚¬ ì§€ì •</small>
                        </div>
                        <% } %>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="card bg-primary text-white">
                      <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2">ì´ í¬ì¸íŠ¸</h6>
                        <% 
                          const actualTotalPoints = totalBasePoints + totalSelfPoints + totalExcellentPoints;
                        %>
                        <h4 class="card-text"><%= actualTotalPoints.toLocaleString() %> P</h4>
                        <small>ì‚¬ìš© ê°€ëŠ¥</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title text-center mb-3">ì„œë¹„ìŠ¤ ë¶€ë¬¸ë³„ ì‚¬ìš© í˜„í™©</h5>
                <canvas id="serviceCategoryChart"></canvas>
                <div class="mt-2 text-center">
                  <small class="text-muted">
                    <% 
                      let categoryTotalUsed = 0;
                      if (typeof serviceCategoryUsage !== 'undefined') {
                        Object.keys(serviceCategoryUsage).forEach(category => { 
                          if(serviceCategoryUsage[category] && serviceCategoryUsage[category].totalUsed) {
                            categoryTotalUsed += serviceCategoryUsage[category].totalUsed;
                          }
                        });
                      }
                    %>
                    ì´ ì‚¬ìš©ëŸ‰: <%= categoryTotalUsed.toLocaleString() %> P
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>ê²Œì„ëª…</th>
                <th>í”Œë«í¼</th>
                <th class="text-end">ê¸°ë³¸ í¬ì¸íŠ¸</th>
                <th class="text-end">ìë¶€ë‹´ í¬ì¸íŠ¸</th>
                <th class="text-end">ì´ í¬ì¸íŠ¸</th>
              </tr>
            </thead>
            <tbody>
              <% games.forEach(game => { %>
                <tr>
                  <td><%= game.game_name %></td>
                  <td>
                    <% 
                      let badgeClass = "bg-secondary";
                      const platform = game.platform.toLowerCase();
                      if (platform.includes('ëª¨ë°”ì¼')) {
                        badgeClass = "bg-primary";
                      } else if (platform.includes('pc') || platform.includes('vr') || platform.includes('ì½˜ì†”')) {
                        badgeClass = "bg-danger";
                      } else if (platform.includes('ì›¹')) {
                        badgeClass = "bg-success";
                      }
                    %>
                    <span class="badge <%= badgeClass %>"><%= game.platform %></span>
                  </td>
                  <td class="text-end"><%= game.base_points.toLocaleString() %></td>
                  <td class="text-end"><%= game.self_points.toLocaleString() %></td>
                  <td class="text-end"><strong><%= game.total_points.toLocaleString() %></strong></td>
                </tr>
              <% }); %>
            </tbody>
            <tfoot class="table-light">
              <tr>
                <td colspan="2"><strong>í•©ê³„</strong></td>
                <td class="text-end"><strong><%= totalBasePoints.toLocaleString() %></strong></td>
                <td class="text-end"><strong><%= totalSelfPoints.toLocaleString() %></strong></td>
                <td class="text-end"><strong><%= totalPoints.toLocaleString() %></strong></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ê³„ì•½ ì •ë³´ ì„¹ì…˜ ì¶”ê°€ -->
<div class="row mb-4">
  <div class="col-md-12">
    <div class="card shadow">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0"><%= companyName %> ì§„í–‰ ì¤‘ì¸ ê³„ì•½ ì •ë³´</h5>
      </div>
      <div class="card-body">
        <% if (contracts && contracts.length > 0) { %>
          <!-- í•„í„°ë§ ì»¨íŠ¸ë¡¤ ì¶”ê°€ -->
          <div class="row mb-3">
            <div class="col-md-6">
              <div class="input-group">
                <label class="input-group-text" for="statusFilter">ì§„í–‰ìƒí™© í•„í„°</label>
                <select class="form-select" id="statusFilter">
                  <option value="all" selected>ëª¨ë“  ìƒíƒœ</option>
                  <% contractStatusList.forEach(status => { %>
                    <option value="<%= status %>"><%= status %></option>
                  <% }); %>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <!-- ê³„ì•½ ìƒíƒœ ë¶„í¬ ì‹œê°í™” -->
              <canvas id="contractStatusChart" height="100"></canvas>
            </div>
          </div>
          
          <div class="table-responsive">
            <table class="table table-hover table-sm contract-table" id="contractsTable">
              <thead class="table-light">
                <tr>
                  <th style="width: 5%;">ë²ˆí˜¸</th>
                  <th style="width: 8%;">ì„œë¹„ìŠ¤ ë¶€ë¬¸</th>
                  <th style="width: 12%;">ìƒì„¸ ì„œë¹„ìŠ¤ í•­ëª©</th>
                  <th style="width: 15%;">ì„œë¹„ìŠ¤ ìš”ì²­ëª…</th>
                  <th style="width: 6%;">ê²¬ì ì„œ ì œì¶œ ê±´</th>
                  <th style="width: 8%;">ì…ì°° ë§ˆê°ì¼</th>
                  <th style="width: 8%;">ì„ ì • ë§ˆê°ì¼</th>
                  <th style="width: 8%;">ì§„í–‰ìƒí™©</th>
                  <th style="width: 10%;">ì„ ì • í˜‘ë ¥ì‚¬</th>
                  <th style="width: 10%;">ê³„ì•½ê¸ˆì•¡</th>
                  <th style="width: 6%;">ì—…ë¬´ìƒíƒœ</th>
                  <% if (userRole === 'ì–´ë“œë¯¼' || userRole === 'ë§¤ë‹ˆì €') { %>
                  <th style="width: 8%;" class="text-center">ìë¶€ë‹´ í¬ì¸íŠ¸</th>
                  <% } %>
                  <th style="width: 4%;" class="text-center">ê²¬ì ì„œì œì¶œí˜„í™©</th>
                </tr>
              </thead>
              <tbody>
                <% contracts.forEach((contract, index) => { %>
                  <tr data-status="<%= contract.status %>">
                    <td><%= contract.contract_id %></td>
                    <td class="text-truncate" style="max-width: 100px;" title="<%= contract.service_category %>"><%= contract.service_category %></td>
                    <td class="text-truncate" style="max-width: 150px;" title="<%= contract.service_detail %>"><%= contract.service_detail %></td>
                    <td class="text-truncate" style="max-width: 200px;" title="<%= contract.service_request %>"><%= contract.service_request %></td>
                    <td><%= contract.quote_count %></td>
                    <td><%= contract.bid_deadline %></td>
                    <td><%= contract.selection_deadline %></td>
                    <td>
                      <span class="badge <%= 
                        contract.status === 'ê²¬ì ìš”ì²­' ? 'bg-primary' : 
                        contract.status === 'ê²¬ì ì„œ ì œì¶œ' ? 'bg-success' : 
                        contract.status === 'ì„ ì •ì™„ë£Œ' ? 'bg-warning' : 
                        contract.status === 'ê³„ì•½ì™„ë£Œ' ? 'bg-info' : 
                        contract.status === 'ìµœì¢…ê³„ì•½ì²´ê²°' ? 'bg-danger' : 'bg-secondary' 
                      %>">
                        <%= contract.status %>
                      </span>
                    </td>
                    <td>
                      <%= contract.selected_vendor ? contract.selected_vendor : '-' %>
                    </td>
                    <td>
                      <% if (contract.contract_amount && contract.contract_amount.trim() !== '') { %>
                        <% 
                          let formattedAmount = contract.contract_amount;
                          const amountMatch = formattedAmount.match(/[\d,]+/);
                          if (amountMatch) {
                            const numberPart = amountMatch[0].replace(/,/g, '');
                            if (!isNaN(numberPart)) {
                              const formatted = Number(numberPart).toLocaleString('ko-KR');
                              formattedAmount = formattedAmount.replace(amountMatch[0], formatted);
                            }
                          }
                          // 'ì›'ì„ 'P'ë¡œ ë³€ê²½
                          formattedAmount = formattedAmount.replace(/ì›$/, 'P');
                        %>
                        <%= formattedAmount %>
                      <% } else { %>
                        -
                      <% } %>
                    </td>
                    <td>
                      <% if (contract.work_status && contract.work_status.trim() !== '') { %>
                        <span class="badge <%= 
                          contract.work_status === 'ì˜ˆì •' ? 'bg-info' : 
                          contract.work_status === 'ì§„í–‰ ì¤‘' ? 'bg-success' : 
                          contract.work_status === 'ì—…ë¬´ ì¢…ë£Œ' ? 'bg-secondary' : 'bg-light text-dark' 
                        %>">
                          <%= contract.work_status %>
                        </span>
                      <% } else { %>
                        -
                      <% } %>
                    </td>
                    <% if (userRole === 'ì–´ë“œë¯¼' || userRole === 'ë§¤ë‹ˆì €') { %>
                    <td class="text-center">
                      <% if (contract.contract_amount && contract.selected_vendor) { %>
                        <div class="form-check form-switch d-inline-block">
                          <input class="form-check-input" 
                                 type="checkbox" 
                                 id="pointSwitch<%= contract.contract_id %>"
                                 data-contract-id="<%= contract.contract_id %>"
                                 <%= contract.use_self_points ? 'checked' : '' %>
                                 onchange="togglePointUsage(this)">
                        </div>
                        <% if (contract.contract_amount) { %>
                        <div class="mt-1">
                          <small class="<%= contract.use_self_points ? 'text-primary' : 'text-secondary' %>">
                            <%= contract.use_self_points ? 'ìë¶€ë‹´ ìš°ì„  ì‚¬ìš©' : 'ê¸°ë³¸ í¬ì¸íŠ¸ë§Œ ì‚¬ìš©' %>
                          </small>
                        </div>
                        <% } %>
                      <% } else { %>
                        <span class="text-muted">-</span>
                      <% } %>
                    </td>
                    <% } %>
                    <td class="text-center">
                      <% if (contract.quote_details && contract.quote_details !== 'ì—†ìŒ' && contract.quote_details.trim() !== '') { %>
                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#quoteModal<%= index %>">
                          ë³´ê¸°
                        </button>

                        <!-- ê²¬ì ì„œì œì¶œí˜„í™© ëª¨ë‹¬ -->
                        <div class="modal fade" id="quoteModal<%= index %>" tabindex="-1" aria-labelledby="quoteModalLabel<%= index %>" aria-hidden="true">
                          <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title" id="quoteModalLabel<%= index %>">ê²¬ì ì„œì œì¶œí˜„í™© - <%= contract.service_request %></h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                              </div>
                              <div class="modal-body">
                                <div class="card">
                                  <div class="card-header">
                                    <h6 class="mb-0">ê³„ì•½ ì •ë³´</h6>
                                  </div>
                                  <div class="card-body">
                                    <div class="row mb-2">
                                      <div class="col-md-4"><strong>ë²ˆí˜¸:</strong> <%= contract.contract_id %></div>
                                      <div class="col-md-4"><strong>ì„œë¹„ìŠ¤ ë¶€ë¬¸:</strong> <%= contract.service_category %></div>
                                      <div class="col-md-4"><strong>ì„œë¹„ìŠ¤ í•­ëª©:</strong> <%= contract.service_detail %></div>
                                    </div>
                                    <div class="row mb-2">
                                      <div class="col-md-8"><strong>ì„œë¹„ìŠ¤ ìš”ì²­ëª…:</strong> <%= contract.service_request %></div>
                                      <div class="col-md-4"><strong>ê²Œì„ì‚¬:</strong> <%= contract.company_name %></div>
                                    </div>
                                    <% if (contract.selected_vendor || contract.contract_amount) { %>
                                    <div class="row">
                                      <div class="col-md-4">
                                        <strong>ì„ ì • í˜‘ë ¥ì‚¬:</strong> 
                                        <%= contract.selected_vendor ? contract.selected_vendor : 'ë¯¸í™•ì •' %>
                                      </div>
                                      <div class="col-md-4">
                                        <strong>ê³„ì•½ê¸ˆì•¡:</strong> 
                                        <% if (contract.contract_amount && contract.contract_amount.trim() !== '') { %>
                                          <% 
                                            let formattedAmount = contract.contract_amount;
                                            const amountMatch = formattedAmount.match(/[\d,]+/);
                                            if (amountMatch) {
                                              const numberPart = amountMatch[0].replace(/,/g, '');
                                              if (!isNaN(numberPart)) {
                                                const formatted = Number(numberPart).toLocaleString('ko-KR');
                                                formattedAmount = formattedAmount.replace(amountMatch[0], formatted);
                                              }
                                            }
                                            // 'ì›'ì„ 'P'ë¡œ ë³€ê²½
                                            formattedAmount = formattedAmount.replace(/ì›$/, 'P');
                                          %>
                                          <%= formattedAmount %>
                                        <% } else { %>
                                          ë¯¸í™•ì •
                                        <% } %>
                                      </div>
                                      <div class="col-md-4">
                                        <strong>ì—…ë¬´ìƒíƒœ:</strong> 
                                        <% if (contract.work_status && contract.work_status.trim() !== '') { %>
                                          <span class="badge <%= 
                                            contract.work_status === 'ì˜ˆì •' ? 'bg-info' : 
                                            contract.work_status === 'ì§„í–‰ ì¤‘' ? 'bg-success' : 
                                            contract.work_status === 'ì—…ë¬´ ì¢…ë£Œ' ? 'bg-secondary' : 'bg-light text-dark' 
                                          %>">
                                            <%= contract.work_status %>
                                          </span>
                                        <% } else { %>
                                          -
                                        <% } %>
                                      </div>
                                    </div>
                                    <% } %>
                                  </div>
                                </div>
                                
                                <div class="card mt-3">
                                  <div class="card-header">
                                    <h6 class="mb-0">ê²¬ì ì„œ ì œì¶œ í˜„í™©</h6>
                                  </div>
                                  <div class="card-body">
                                    <% 
                                      // ê²¬ì ì„œ ë°ì´í„° ì²˜ë¦¬
                                      const quoteDetails = contract.quote_details || '';
                                      
                                      if (quoteDetails && quoteDetails !== 'ì—†ìŒ' && quoteDetails.trim() !== '') {
                                        // ê²¬ì ì„œ ëª©ë¡ ìƒì„±
                                        const quotes = [];
                                        
                                        // ë””ë²„ê¹… ì •ë³´ - ì›ë³¸ ë°ì´í„° ì¶œë ¥
                                        console.log('ì›ë³¸ ê²¬ì  ë°ì´í„°:', quoteDetails);
                                        
                                        // ì¤„ë°”ê¿ˆ ë¬¸ì ì²˜ë¦¬ (ë‹¤ì–‘í•œ ì¤„ë°”ê¿ˆ ë¬¸ì ëŒ€ì‘)
                                        // \n, \r, \r\n ëª¨ë‘ ì²˜ë¦¬
                                        const normalizedDetails = quoteDetails.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                                        
                                        // ë””ë²„ê¹… ì •ë³´ - ì •ê·œí™”ëœ ë°ì´í„° ì¶œë ¥
                                        console.log('ì •ê·œí™”ëœ ê²¬ì  ë°ì´í„°:', normalizedDetails);
                                        
                                        if (normalizedDetails.includes('\n')) {
                                          // ì¤„ë°”ê¿ˆìœ¼ë¡œ ë¶„ë¦¬
                                          const lines = normalizedDetails.split('\n');
                                          console.log('ë¶„ë¦¬ëœ ê²¬ì  ë¼ì¸ ìˆ˜:', lines.length);
                                          
                                          lines.forEach((line, i) => {
                                            if (line.trim()) {
                                              console.log(`ê²¬ì  ë¼ì¸ ${i+1}:`, line.trim());
                                              quotes.push(line.trim());
                                            }
                                          });
                                        } else {
                                          // ë‹¨ì¼ ê²¬ì ì„œ
                                          quotes.push(normalizedDetails.trim());
                                        }
                                        
                                        console.log('ì²˜ë¦¬ëœ ê²¬ì  í•­ëª© ìˆ˜:', quotes.length);
                                    %>
                                      <div class="table-responsive">
                                        <table class="table table-bordered table-hover">
                                          <thead class="table-light">
                                            <tr>
                                              <th>í˜‘ë ¥ì‚¬ëª…</th>
                                              <th>ê²¬ì </th>
                                              <th>ê²¬ì ì¼ì</th>
                                            </tr>
                                          </thead>
                                          <tbody>
                                            <% 
                                              // ê° ê²¬ì ì„œ í•­ëª© ì²˜ë¦¬
                                              quotes.forEach(quote => {
                                                // í˜‘ë ¥ì‚¬(ê¸ˆì•¡, ë‚ ì§œ) í˜•ì‹ ì¶”ì¶œ
                                                // ê¸ˆì•¡ì— ì‰¼í‘œê°€ í¬í•¨ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë§ˆì§€ë§‰ ì‰¼í‘œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¦¬
                                                const regex = /(.+?)\((.+),\s*(\d{4}-\d{2}-\d{2})\)/;
                                                const match = quote.match(regex);
                                                
                                                if (match) {
                                                  const vendor = match[1].trim();
                                                  const amount = match[2].trim();
                                                  const date = match[3].trim();
                                            %>
                                              <tr>
                                                <td><%= vendor %></td>
                                                <td><%= amount.replace(/ì›$/, 'P') %></td>
                                                <td><%= date %></td>
                                              </tr>
                                            <% } else { %>
                                              <tr>
                                                <td colspan="3" class="text-center">
                                                  <%= quote %>
                                                </td>
                                              </tr>
                                            <% }
                                            }); 
                                            %>
                                          </tbody>
                                        </table>
                                      </div>
                                    <% } else { %>
                                      <div class="alert alert-info mb-0">
                                        <i class="bi bi-info-circle me-2"></i> ì œì¶œëœ ê²¬ì ì„œê°€ ì—†ìŠµë‹ˆë‹¤.
                                      </div>
                                    <% } %>
                                  </div>
                                </div>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                              </div>
                            </div>
                          </div>
                        </div>
                      <% } else { %>
                        <span class="text-muted">ì—†ìŒ</span>
                      <% } %>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
          <div class="mt-3">
            <p class="text-muted"><small>* ê³„ì•½ ì •ë³´ëŠ” 1ì‹œê°„ë§ˆë‹¤ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤. ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <%= new Date().toLocaleString('ko-KR') %></small></p>
          </div>
        <% } else { %>
          <div class="alert alert-warning">
            <p><i class="bi bi-exclamation-triangle-fill me-2"></i> í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ê³„ì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <% if (userRole === 'ì–´ë“œë¯¼') { %>
            <p>í™ˆí˜ì´ì§€ì—ì„œ 'ë°ì´í„° ë™ê¸°í™”' ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìµœì‹  ê³„ì•½ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì„¸ìš”.</p>
            <% } %>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- ê¸€ë¡œë²Œ ì„±ê³¼ í˜„í™© ì„¹ì…˜ ì¶”ê°€ -->
<div class="row mb-4">
  <div class="col-md-12">
    <div class="card shadow">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0"><%= companyName %> ê¸€ë¡œë²Œ ì„±ê³¼ í˜„í™©</h5>
      </div>
      <div class="card-body">
        <!-- ë°ì´í„° ì„¤ëª… ì¶”ê°€ -->
        <div class="alert alert-light border mb-4">
          <h6 class="mb-2"><i class="bi bi-info-circle me-2"></i>ë°ì´í„° ì„¤ëª…</h6>
          <ul class="mb-0 small">
            <li><strong>ê¸€ë¡œë²Œ</strong>: í•œêµ­ì„ ì œì™¸í•œ ì „ì„¸ê³„ ëª¨ë“  êµ­ê°€ì˜ í•©ê³„ ë°ì´í„°</li>
            <li><strong>ì§„ì¶œêµ­ê°€</strong>: ê²Œì„ì‚¬ê°€ ì§€ì •í•œ 6ê°œ êµ­ê°€ì˜ í•©ê³„ ë°ì´í„° (ê¸€ë¡œë²Œ ë°ì´í„°ì˜ ì¼ë¶€)</li>
            <li><strong>ì§€í‘œë³„ íŠ¹ì„±</strong>: ë§¤ì¶œ/ë‹¤ìš´ë¡œë“œ/ìœ„ì‹œë¦¬ìŠ¤íŠ¸ëŠ” ê¸°ê°„ ë‚´ í•©ê³„, DAUëŠ” ê¸°ê°„ ë‚´ í‰ê· ê°’ìœ¼ë¡œ í‘œì‹œ</li>
            <li><strong>ë°ì´í„° ì¶œì²˜</strong>: ê²Œì„ì‚¬ê°€ ê³µìœ í•œ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë°ì´í„° ê¸°ë°˜</li>
          </ul>
        </div>
        
        <!-- í•„í„°ë§ ì»¨íŠ¸ë¡¤ -->
        <div class="row mb-4">
          <div class="col-md-4 mb-3">
            <!-- ì§€í‘œ ì„ íƒ ë²„íŠ¼ ê·¸ë£¹ -->
            <div class="btn-group" role="group" aria-label="ì§€í‘œ ì„ íƒ">
              <input type="radio" class="btn-check" name="metricRadio" id="metricRevenue" value="revenue" checked>
              <label class="btn btn-outline-primary" for="metricRevenue">ë§¤ì¶œ</label>
              
              <input type="radio" class="btn-check" name="metricRadio" id="metricDownloads" value="downloads">
              <label class="btn btn-outline-primary" for="metricDownloads">ë‹¤ìš´ë¡œë“œ</label>
              
              <input type="radio" class="btn-check" name="metricRadio" id="metricDau" value="dau">
              <label class="btn btn-outline-primary" for="metricDau">DAU</label>
              
              <input type="radio" class="btn-check" name="metricRadio" id="metricWishlist" value="wishlist">
              <label class="btn btn-outline-primary" for="metricWishlist">ìœ„ì‹œë¦¬ìŠ¤íŠ¸</label>
            </div>
          </div>
          <div class="col-md-8">
            <div class="input-group">
              <label class="input-group-text" for="startDate">ê¸°ê°„ ì„ íƒ</label>
              <input type="date" class="form-control" id="startDate">
              <span class="input-group-text">~</span>
              <input type="date" class="form-control" id="endDate">
              <button class="btn btn-outline-primary" id="applyDateFilter">ì ìš©</button>
            </div>
          </div>
        </div>
        
        <div id="performanceChartContainer">
          <canvas id="performanceChart" height="300"></canvas>
        </div>
        
        <!-- ëˆ„ì  ë°ì´í„° í‘œì‹œ ì„¹ì…˜ ì¶”ê°€ -->
        <div class="row mt-4" id="accumulatedDataContainer">
          <!-- ë°ì´í„° í‘œì‹œ ë°©ì‹ ì„ íƒ íƒ­ -->
          <div class="col-12 mb-3">
            <ul class="nav nav-pills" id="dataViewTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="sum-tab" data-bs-toggle="pill" data-bs-target="#sum-data" type="button" role="tab" aria-controls="sum-data" aria-selected="true">ê¸°ê°„ ë‚´ í•©ê³„</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="avg-tab" data-bs-toggle="pill" data-bs-target="#avg-data" type="button" role="tab" aria-controls="avg-data" aria-selected="false">ê¸°ê°„ ë‚´ í‰ê· </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="total-tab" data-bs-toggle="pill" data-bs-target="#total-data" type="button" role="tab" aria-controls="total-data" aria-selected="false">ì „ì²´ ë°ì´í„° í•©ê³„</button>
              </li>
            </ul>
          </div>
          
          <div class="tab-content" id="dataViewTabContent">
            <!-- ê¸°ê°„ ë‚´ í•©ê³„ íƒ­ -->
            <div class="tab-pane fade show active" id="sum-data" role="tabpanel" aria-labelledby="sum-tab">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <div class="card border-0 shadow-sm h-100">
                    <div class="card-body p-4 d-flex flex-column">
                      <h5 class="card-title text-muted mb-3">ê¸€ë¡œë²Œ <small class="text-info">(ê¸°ê°„ ë‚´ í•©ê³„)</small></h5>
                      <h2 class="card-text fw-bold mb-0" id="globalAccumulatedValue">0</h2>
                      <p class="card-text mt-2 mt-auto"><span id="globalChangeRate" class="badge rounded-pill"></span></p>
                    </div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <div class="card border-0 shadow-sm h-100">
                    <div class="card-body p-4 d-flex flex-column">
                      <h5 class="card-title text-muted mb-3">ì§„ì¶œêµ­ê°€ <small class="text-info">(ê¸°ê°„ ë‚´ í•©ê³„)</small></h5>
                      <h2 class="card-text fw-bold mb-0" id="targetAccumulatedValue">0</h2>
                      <p class="card-text mt-2 mt-auto"><span id="targetChangeRate" class="badge rounded-pill"></span></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ê¸°ê°„ ë‚´ í‰ê·  íƒ­ -->
            <div class="tab-pane fade" id="avg-data" role="tabpanel" aria-labelledby="avg-tab">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <div class="card border-0 shadow-sm h-100">
                    <div class="card-body p-4 d-flex flex-column">
                      <h5 class="card-title text-muted mb-3">ê¸€ë¡œë²Œ <small class="text-info">(ê¸°ê°„ ë‚´ í‰ê· )</small></h5>
                      <h2 class="card-text fw-bold mb-0" id="globalAverageValue">0</h2>
                      <p class="card-text mt-2 mt-auto"><small class="text-muted">ì¼ í‰ê·  ê°’</small></p>
                    </div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <div class="card border-0 shadow-sm h-100">
                    <div class="card-body p-4 d-flex flex-column">
                      <h5 class="card-title text-muted mb-3">ì§„ì¶œêµ­ê°€ <small class="text-info">(ê¸°ê°„ ë‚´ í‰ê· )</small></h5>
                      <h2 class="card-text fw-bold mb-0" id="targetAverageValue">0</h2>
                      <p class="card-text mt-2 mt-auto"><small class="text-muted">ì¼ í‰ê·  ê°’</small></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ì „ì²´ ë°ì´í„° í•©ê³„ íƒ­ -->
            <div class="tab-pane fade" id="total-data" role="tabpanel" aria-labelledby="total-tab">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <div class="card border-0 shadow-sm h-100">
                    <div class="card-body p-4 d-flex flex-column">
                      <h5 class="card-title text-muted mb-3">ê¸€ë¡œë²Œ <small class="text-info">(ì „ì²´ í•©ê³„)</small></h5>
                      <h2 class="card-text fw-bold mb-0" id="globalTotalValue">0</h2>
                      <p class="card-text mt-2 mt-auto"><small class="text-muted">ì „ì²´ ê¸°ê°„ ë°ì´í„° í•©ì‚°</small></p>
                    </div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <div class="card border-0 shadow-sm h-100">
                    <div class="card-body p-4 d-flex flex-column">
                      <h5 class="card-title text-muted mb-3">ì§„ì¶œêµ­ê°€ <small class="text-info">(ì „ì²´ í•©ê³„)</small></h5>
                      <h2 class="card-text fw-bold mb-0" id="targetTotalValue">0</h2>
                      <p class="card-text mt-2 mt-auto"><small class="text-muted">ì „ì²´ ê¸°ê°„ ë°ì´í„° í•©ì‚°</small></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="mt-3">
          <p class="text-muted"><small>* ì„±ê³¼ í˜„í™© ë°ì´í„°ëŠ” ë§¤ì¼ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤. <span id="lastUpdateInfo"></span></small></p>
          <% if (userRole === 'ì–´ë“œë¯¼') { %>
          <div class="text-end">
            <a href="/sync-performance?from=<%= encodeURIComponent('/games/company/' + companyName) %>" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-arrow-repeat"></i> ì„±ê³¼ í˜„í™© ë°ì´í„° ë™ê¸°í™”
            </a>
          </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // ì„œë¹„ìŠ¤ ë¶€ë¬¸ë³„ ì‚¬ìš©ëŸ‰ ì°¨íŠ¸ ìƒì„±
  var serviceCtx = document.getElementById('serviceCategoryChart').getContext('2d');
  
  // ì„œë¹„ìŠ¤ ë¶€ë¬¸ë³„ ë°ì´í„° ì¤€ë¹„
  var categories = [];
  var usageData = [];
  var backgroundColors = [];
  
  <% 
    // ìƒ‰ìƒ ì •ì˜
    const categoryColors = {
      'ê²Œì„ ì„œë¹„ìŠ¤': 'rgba(74, 86, 141, 0.8)',
      'ë§ˆì¼€íŒ…': 'rgba(90, 138, 90, 0.8)',
      'ì¸í”„ë¼': 'rgba(200, 168, 105, 0.8)',
      'ì»¨ì„¤íŒ…': 'rgba(107, 155, 210, 0.8)',
      'ê¸°íƒ€': 'rgba(122, 122, 122, 0.8)',
      'ë¯¸ì‚¬ìš© í¬ì¸íŠ¸': 'rgba(220, 220, 220, 0.8)'
    };
    
    // ì´ ì‚¬ìš©ëŸ‰ ê³„ì‚°
    let totalUsed = 0;
    if (typeof serviceCategoryUsage !== 'undefined') {
      Object.keys(serviceCategoryUsage).forEach(category => { 
        if(serviceCategoryUsage[category] && serviceCategoryUsage[category].totalUsed) {
          totalUsed += serviceCategoryUsage[category].totalUsed;
        }
      });
    }
    
    // ë¯¸ì‚¬ìš© í¬ì¸íŠ¸ ê³„ì‚°
    const unusedPoints = totalPoints - totalUsed;
  %>
  
  <% if (typeof serviceCategoryUsage !== 'undefined') {
      Object.keys(serviceCategoryUsage).forEach(category => { 
        if (serviceCategoryUsage[category] && serviceCategoryUsage[category].totalUsed > 0) { %>
    categories.push('<%= category %>');
    usageData.push(<%= serviceCategoryUsage[category].totalUsed %>);
    backgroundColors.push('<%= categoryColors[category] || "rgba(122, 122, 122, 0.8)" %>');
  <% } });
    } %>
  
  <% if (unusedPoints > 0) { %>
    categories.push('ë¯¸ì‚¬ìš© í¬ì¸íŠ¸');
    usageData.push(<%= unusedPoints %>);
    backgroundColors.push('<%= categoryColors["ë¯¸ì‚¬ìš© í¬ì¸íŠ¸"] %>');
  <% } %>
  
  new Chart(serviceCtx, {
    type: 'doughnut',
    data: {
      labels: categories,
      datasets: [{
        data: usageData,
        backgroundColor: backgroundColors,
        borderWidth: 1,
        borderColor: '#ffffff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        title: {
          display: false
        },
        legend: {
          position: 'bottom',
          labels: {
            padding: 10,
            font: {
              size: 11
            }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              var label = context.label || '';
              var value = context.raw || 0;
              var percentage = Math.round((value / <%= totalPoints %>) * 100);
              return label + ': ' + value.toLocaleString() + ' P (' + percentage + '%)';
            }
          }
        }
      }
    }
  });
  
  <% if (contracts && contracts.length > 0) { %>
  // ê³„ì•½ ìƒíƒœë³„ í•„í„°ë§ ë¡œì§
  document.getElementById('statusFilter').addEventListener('change', function() {
    var selectedStatus = this.value;
    var rows = document.querySelectorAll('#contractsTable tbody tr');
    
    rows.forEach(function(row) {
      var status = row.getAttribute('data-status');
      if (selectedStatus === 'all' || status === selectedStatus) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  });
  
  // ê³„ì•½ ìƒíƒœ ì°¨íŠ¸ ìƒì„±
  var statusCounts = {
    <% contractStatusList.forEach(status => { %>
    '<%= status %>': 0,
    <% }); %>
    'ê¸°íƒ€': 0
  };
  
  // ìƒíƒœë³„ ì¹´ìš´íŠ¸ ê³„ì‚°
  document.querySelectorAll('#contractsTable tbody tr').forEach(function(row) {
    var status = row.getAttribute('data-status');
    if (statusCounts.hasOwnProperty(status)) {
      statusCounts[status]++;
    } else {
      statusCounts['ê¸°íƒ€']++;
    }
  });
  
  // ìƒíƒœë³„ ìƒ‰ìƒ ë§¤í•‘
  var statusColors = {
    'ê²¬ì ìš”ì²­': 'rgba(13, 110, 253, 0.7)',
    'ê²¬ì ì„œ ì œì¶œ': 'rgba(25, 135, 84, 0.7)',
    'ì„ ì •ì™„ë£Œ': 'rgba(255, 193, 7, 0.7)',
    'ê³„ì•½ì™„ë£Œ': 'rgba(13, 202, 240, 0.7)',
    'ê¸°íƒ€': 'rgba(108, 117, 125, 0.7)'
  };
  
  // ë°ì´í„° ì¤€ë¹„
  var statuses = Object.keys(statusCounts);
  var counts = Object.values(statusCounts);
  var colors = statuses.map(function(status) { 
    return statusColors[status] || 'rgba(108, 117, 125, 0.7)';
  });
  
  // ê³„ì•½ ìƒíƒœ ì°¨íŠ¸ ìƒì„±
  var statusCtx = document.getElementById('contractStatusChart').getContext('2d');
  new Chart(statusCtx, {
    type: 'doughnut',
    data: {
      labels: statuses,
      datasets: [{
        data: counts,
        backgroundColor: colors,
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              var label = context.label || '';
              var value = context.raw || 0;
              var total = context.dataset.data.reduce(function(a, b) { return a + b; }, 0);
              var percentage = Math.round((value / total) * 100);
              return label + ': ' + value + 'ê±´ (' + percentage + '%)';
            }
          }
        }
      }
    }
  });
  <% } %>

  // ì„±ê³¼ í˜„í™© ì°¨íŠ¸ ìƒì„±
  const performanceCtx = document.getElementById('performanceChart').getContext('2d');
  let performanceChart = null;
  
  // ì„±ê³¼ í˜„í™© ë°ì´í„° ë””ë²„ê¹…
  console.log('ì„±ê³¼ í˜„í™© ë°ì´í„° ë””ë²„ê¹… ì‹œì‘');
  const performanceData = <%- JSON.stringify(gamePerformanceData || {}) %>;
  console.log('ì„±ê³¼ í˜„í™© ë°ì´í„°:', performanceData);
  
  // ê¸°ë³¸ ì§€í‘œ, ê¸°ê°„ ì„¤ì •
  let currentMetric = '<%= defaultMetric || "revenue" %>';
  let currentPeriod = 'custom'; // ì»¤ìŠ¤í…€ ê¸°ê°„ìœ¼ë¡œ ë³€ê²½
  
  // ë‚ ì§œ ë²”ìœ„ ì„¤ì • (ê¸°ë³¸: í˜„ì¬ ë‚ ì§œì—ì„œ 30ì¼ ì „)
  const today = new Date();
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(today.getDate() - 30);
  
  // ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜ (YYYY-MM-DD)
  function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }
  
  let startDate = formatDate(thirtyDaysAgo);
  let endDate = formatDate(today);
  
  // ì´ˆê¸° ë‚ ì§œ ì„¤ì •
  document.getElementById('startDate').value = startDate;
  document.getElementById('endDate').value = endDate;
  
  console.log('í˜„ì¬ ì„¤ì •:', { currentMetric, startDate, endDate });
  
  // ì°¨íŠ¸ ìƒ‰ìƒ ì„¤ì •
  const chartColors = {
    line: 'rgba(75, 192, 192, 1)',
    anomaly: 'rgba(255, 99, 132, 1)',
    movingAvg: 'rgba(54, 162, 235, 0.5)'
  };
  
  // ì„±ê³¼ í˜„í™© ì°¨íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updatePerformanceChart() {
    try {
      console.log('ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ì‹œì‘');
      
      // ë°ì´í„° í™•ì¸ ë° ë””ë²„ê¹…
      console.log('ì„±ê³¼ í˜„í™© ë°ì´í„° í™•ì¸:', performanceData);
      
      // í˜„ì¬ ì„ íƒëœ ì§€í‘œ, ê¸°ê°„ì— ëŒ€í•œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      if (!performanceData) {
        console.error('ì„±ê³¼ í˜„í™© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        document.getElementById('performanceChartContainer').innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i> ì„±ê³¼ í˜„í™© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
          </div>
        `;
        return;
      }
      
      // ë°ì´í„° êµ¬ì¡° í™•ì¸
      if (!performanceData[currentMetric]) {
        console.error(`${currentMetric} ì§€í‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
        document.getElementById('performanceChartContainer').innerHTML = `
          <div class="alert alert-warning">
            <i class="bi bi-info-circle me-2"></i> ${currentMetric} ì§€í‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
          </div>
        `;
        return;
      }
      
      // ë‚ ì§œ ë²”ìœ„ ê°€ì ¸ì˜¤ê¸°
      const start = new Date(document.getElementById('startDate').value);
      const end = new Date(document.getElementById('endDate').value);
      
      // ì¼ë³„ ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§ (daily ë°ì´í„°ê°€ ê°€ì¥ ìƒì„¸í•¨)
      const periodToUse = 'daily';
      
      // ê¸€ë¡œë²Œ ë°ì´í„° í™•ì¸ ë° í•„í„°ë§
      let filteredGlobalData = [];
      let allGlobalData = [];
      const hasGlobalData = performanceData[currentMetric].global && 
                           performanceData[currentMetric].global[periodToUse] && 
                           performanceData[currentMetric].global[periodToUse].length > 0;
      
      if (hasGlobalData) {
        // ì „ì²´ ë°ì´í„° ì €ì¥
        allGlobalData = [...performanceData[currentMetric].global[periodToUse]];
        
        // ì„ íƒëœ ê¸°ê°„ í•„í„°ë§
        filteredGlobalData = performanceData[currentMetric].global[periodToUse].filter(item => {
          const itemDate = new Date(item.date);
          return itemDate >= start && itemDate <= end;
        });
      }
                           
      // ì§„ì¶œêµ­ê°€ ë°ì´í„° í™•ì¸ ë° í•„í„°ë§
      let filteredTargetData = [];
      let allTargetData = [];
      const hasTargetData = performanceData[currentMetric].target && 
                           performanceData[currentMetric].target[periodToUse] && 
                           performanceData[currentMetric].target[periodToUse].length > 0;
      
      if (hasTargetData) {
        // ì „ì²´ ë°ì´í„° ì €ì¥
        allTargetData = [...performanceData[currentMetric].target[periodToUse]];
        
        // ì„ íƒëœ ê¸°ê°„ í•„í„°ë§
        filteredTargetData = performanceData[currentMetric].target[periodToUse].filter(item => {
          const itemDate = new Date(item.date);
          return itemDate >= start && itemDate <= end;
        });
      }
      
      if (filteredGlobalData.length === 0 && filteredTargetData.length === 0) {
        console.log('ì„ íƒí•œ ê¸°ê°„ì— í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        document.getElementById('performanceChartContainer').innerHTML = `
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i> ì„ íƒí•œ ê¸°ê°„ì— í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
          </div>
        `;
        return;
      }
      
      // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ íŒŒê´´
      if (performanceChart) {
        performanceChart.destroy();
      }
      
      // ì§€í‘œë³„ ë‹¨ìœ„ ì„¤ì •
      let yAxisLabel = '';
      switch(currentMetric) {
        case 'revenue':
          yAxisLabel = 'ë§¤ì¶œ (ì›)';
          break;
        case 'downloads':
          yAxisLabel = 'ë‹¤ìš´ë¡œë“œ ìˆ˜';
          break;
        case 'dau':
          yAxisLabel = 'DAU';
          break;
        case 'wishlist':
          yAxisLabel = 'ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ìˆ˜';
          break;
      }
      
      // ë°ì´í„°ì…‹ ì¤€ë¹„
      const datasets = [];
      
      // ë‚ ì§œ ë ˆì´ë¸” ìƒì„± (ëª¨ë“  ë‚ ì§œë¥¼ í¬í•¨í•˜ë„ë¡)
      const allDates = new Set();
      
      // ê¸€ë¡œë²Œ ë°ì´í„°ì˜ ë‚ ì§œ ì¶”ê°€
      filteredGlobalData.forEach(item => allDates.add(item.date));
      
      // ì§„ì¶œêµ­ê°€ ë°ì´í„°ì˜ ë‚ ì§œ ì¶”ê°€
      filteredTargetData.forEach(item => allDates.add(item.date));
      
      // ë‚ ì§œ ì •ë ¬
      const sortedDates = Array.from(allDates).sort();
      
      // ê¸€ë¡œë²Œ ë°ì´í„° ì¶”ê°€
      if (filteredGlobalData.length > 0) {
        // ë‚ ì§œë³„ ê°’ ë§¤í•‘ ë° ì „ì¼ ëŒ€ë¹„ ì¦ê°ë¥  ê³„ì‚°
        const dataMap = {};
        const changeRateMap = {};
        
        // ê°’ ë§¤í•‘
        filteredGlobalData.forEach(item => {
          // ê°’ì´ 0ì¸ ê²½ìš°ì—ë„ ë°ì´í„° í¬ì¸íŠ¸ë¡œ í‘œì‹œí•˜ê¸° ìœ„í•´ nullì´ ì•„ë‹Œ 0ìœ¼ë¡œ ì„¤ì •
          dataMap[item.date] = item.value !== null ? item.value : null;
        });
        
        // ì¦ê°ë¥  ê³„ì‚°
        sortedDates.forEach((date, index) => {
          if (index > 0) {
            const currentValue = dataMap[date];
            const prevValue = dataMap[sortedDates[index - 1]];
            
            if (currentValue !== null && prevValue !== null && prevValue !== 0) {
              const changeRate = ((currentValue - prevValue) / prevValue) * 100;
              changeRateMap[date] = changeRate.toFixed(1);
            } else {
              changeRateMap[date] = null;
            }
          } else {
            changeRateMap[date] = null; // ì²« ë²ˆì§¸ ë°ì´í„°ëŠ” ì¦ê°ë¥  ì—†ìŒ
          }
        });
        
        // ëª¨ë“  ë‚ ì§œì— ëŒ€í•œ ë°ì´í„° ë°°ì—´ ìƒì„± (ì—†ëŠ” ë‚ ì§œëŠ” null)
        const values = sortedDates.map(date => dataMap[date] !== undefined ? dataMap[date] : null);
        
        datasets.push({
          label: `ê¸€ë¡œë²Œ ${yAxisLabel}`,
          data: values,
          borderColor: 'rgb(75, 192, 192)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          borderWidth: 2,
          fill: false,
          spanGaps: false, // 0 ê°’ë„ ì—°ê²°í•˜ê¸° ìœ„í•´ falseë¡œ ì„¤ì •
          changeRates: changeRateMap // ì¦ê°ë¥  ë°ì´í„° ì¶”ê°€
        });
      }
      
      // ì§„ì¶œêµ­ê°€ ë°ì´í„° ì¶”ê°€
      if (filteredTargetData.length > 0) {
        // ë‚ ì§œë³„ ê°’ ë§¤í•‘ ë° ì „ì¼ ëŒ€ë¹„ ì¦ê°ë¥  ê³„ì‚°
        const dataMap = {};
        const changeRateMap = {};
        
        // ê°’ ë§¤í•‘
        filteredTargetData.forEach(item => {
          // ê°’ì´ 0ì¸ ê²½ìš°ì—ë„ ë°ì´í„° í¬ì¸íŠ¸ë¡œ í‘œì‹œí•˜ê¸° ìœ„í•´ nullì´ ì•„ë‹Œ 0ìœ¼ë¡œ ì„¤ì •
          dataMap[item.date] = item.value !== null ? item.value : null;
        });
        
        // ì¦ê°ë¥  ê³„ì‚°
        sortedDates.forEach((date, index) => {
          if (index > 0) {
            const currentValue = dataMap[date];
            const prevValue = dataMap[sortedDates[index - 1]];
            
            if (currentValue !== null && prevValue !== null && prevValue !== 0) {
              const changeRate = ((currentValue - prevValue) / prevValue) * 100;
              changeRateMap[date] = changeRate.toFixed(1);
            } else {
              changeRateMap[date] = null;
            }
          } else {
            changeRateMap[date] = null; // ì²« ë²ˆì§¸ ë°ì´í„°ëŠ” ì¦ê°ë¥  ì—†ìŒ
          }
        });
        
        // ëª¨ë“  ë‚ ì§œì— ëŒ€í•œ ë°ì´í„° ë°°ì—´ ìƒì„± (ì—†ëŠ” ë‚ ì§œëŠ” null)
        const values = sortedDates.map(date => dataMap[date] !== undefined ? dataMap[date] : null);
        
        datasets.push({
          label: `ì§„ì¶œêµ­ê°€ ${yAxisLabel}`,
          data: values,
          borderColor: 'rgb(255, 99, 132)',
          backgroundColor: 'rgba(255, 99, 132, 0.2)',
          borderWidth: 2,
          fill: false,
          spanGaps: false, // 0 ê°’ë„ ì—°ê²°í•˜ê¸° ìœ„í•´ falseë¡œ ì„¤ì •
          changeRates: changeRateMap // ì¦ê°ë¥  ë°ì´í„° ì¶”ê°€
        });
      }
      
      // ì°¨íŠ¸ ìƒì„±
      performanceChart = new Chart(performanceCtx, {
        type: 'line',
        data: {
          labels: sortedDates,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            tooltip: {
              enabled: true,
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleFont: {
                size: 14,
                weight: 'bold'
              },
              bodyFont: {
                size: 13
              },
              padding: 10,
              callbacks: {
                title: function(tooltipItems) {
                  if (!tooltipItems.length) return '';
                  const date = tooltipItems[0].label;
                  if (!date) return '';
                  
                  const parts = date.split('-');
                  if (parts.length !== 3) return date;
                  
                  return `${parts[0]}ë…„ ${parts[1]}ì›” ${parts[2]}ì¼`;
                },
                label: function(tooltipItem) {
                  let label = tooltipItem.dataset.label || '';
                  let value = tooltipItem.raw || 0;
                  
                  // ì§€í‘œì— ë”°ë¥¸ ë‹¨ìœ„ ì¶”ê°€
                  let formattedValue = value !== null ? value.toLocaleString() : 'ë°ì´í„° ì—†ìŒ';
                  
                  // ì§€í‘œë³„ ë‹¨ìœ„ ì„¤ì •
                  if (currentMetric === 'revenue') {
                    formattedValue += ' ì›';
                  } else if (currentMetric === 'downloads') {
                    formattedValue += ' íšŒ';
                  } else if (currentMetric === 'dau') {
                    formattedValue += ' ëª…';
                  } else if (currentMetric === 'wishlist') {
                    formattedValue += ' ê°œ';
                  }
                  
                  return `${label}: ${formattedValue}`;
                },
                afterLabel: function(tooltipItem) {
                  // ì „ì¼ ëŒ€ë¹„ ì¦ê°ë¥  ì¶”ê°€
                  const date = tooltipItem.label;
                  const changeRate = tooltipItem.dataset.changeRates ? tooltipItem.dataset.changeRates[date] : null;
                  if (changeRate !== null && changeRate !== undefined) {
                    const isPositive = parseFloat(changeRate) >= 0;
                    const sign = isPositive ? '+' : '';
                    return `ì „ì¼ ëŒ€ë¹„: ${sign}${changeRate}%`;
                  }
                  return '';
                },
                footer: function(tooltipItems) {
                  // ê¸€ë¡œë²Œê³¼ ì§„ì¶œêµ­ê°€ ë°ì´í„°ê°€ ëª¨ë‘ ìˆëŠ” ê²½ìš° ë¹„ìœ¨ í‘œì‹œ
                  if (tooltipItems.length === 2) {
                    const globalItem = tooltipItems.find(item => item.dataset.label.includes('ê¸€ë¡œë²Œ'));
                    const targetItem = tooltipItems.find(item => item.dataset.label.includes('ì§„ì¶œêµ­ê°€'));
                    
                    if (globalItem && targetItem && globalItem.raw > 0) {
                      const ratio = ((targetItem.raw / globalItem.raw) * 100).toFixed(1);
                      return `ì§„ì¶œêµ­ê°€/ê¸€ë¡œë²Œ ë¹„ìœ¨: ${ratio}%`;
                    }
                  }
                  return '';
                }
              }
            }
          }
        }
      });
      
      // ëˆ„ì  ë°ì´í„° ê³„ì‚° ë° í‘œì‹œ
      let globalAccumulated = 0;
      let targetAccumulated = 0;
      let globalAverage = 0;
      let targetAverage = 0;
      let globalTotal = 0;
      let targetTotal = 0;
      
      // ì§€í‘œ ìœ í˜•ì— ë”°ë¥¸ ì§‘ê³„ ë°©ì‹ ê²°ì •
      const isAverageMetric = currentMetric === 'dau'; // DAUëŠ” í‰ê·  ê³„ì‚°ì´ ë” ì í•©
      
      // ê¸€ë¡œë²Œ ë°ì´í„° ê³„ì‚°
      if (filteredGlobalData.length > 0) {
        // ê¸°ê°„ ë‚´ í•©ê³„ (DAUëŠ” í‰ê· , ë‚˜ë¨¸ì§€ëŠ” í•©ê³„)
        if (isAverageMetric) {
          // DAUëŠ” í‰ê· ê°’ ê³„ì‚°
          globalAccumulated = filteredGlobalData.reduce((sum, item) => {
            return sum + (item.value !== null ? Number(item.value) : 0);
          }, 0) / filteredGlobalData.length;
        } else {
          // ë§¤ì¶œ, ë‹¤ìš´ë¡œë“œ, ìœ„ì‹œë¦¬ìŠ¤íŠ¸ëŠ” í•©ê³„ ê³„ì‚°
          globalAccumulated = filteredGlobalData.reduce((sum, item) => {
            return sum + (item.value !== null ? Number(item.value) : 0);
          }, 0);
        }
        
        // ê¸°ê°„ ë‚´ ì¼í‰ê·  ê³„ì‚°
        globalAverage = filteredGlobalData.reduce((sum, item) => {
          return sum + (item.value !== null ? Number(item.value) : 0);
        }, 0) / filteredGlobalData.length;
        
        // ê¸°ê°„ ë‚´ ì¦ê°ë¥  ê³„ì‚° (ì„ íƒ ê¸°ê°„ì˜ ì²«ë‚ ê³¼ ë§ˆì§€ë§‰ë‚  ë¹„êµ)
        if (filteredGlobalData.length >= 2) {
          const firstDayValue = filteredGlobalData[0].value || 0;
          const lastDayValue = filteredGlobalData[filteredGlobalData.length - 1].value || 0;
          
          if (firstDayValue > 0) {
            const changeRate = ((lastDayValue - firstDayValue) / firstDayValue) * 100;
            const isPositive = changeRate >= 0;
            const sign = isPositive ? '+' : '';
            const badgeClass = isPositive ? 'bg-success' : 'bg-danger';
            document.getElementById('globalChangeRate').className = `badge rounded-pill ${badgeClass}`;
            document.getElementById('globalChangeRate').textContent = `${sign}${changeRate.toFixed(2)}%`;
          }
        }
      }
      
      // ì§„ì¶œêµ­ê°€ ë°ì´í„° ê³„ì‚°
      if (filteredTargetData.length > 0) {
        // ê¸°ê°„ ë‚´ í•©ê³„ (DAUëŠ” í‰ê· , ë‚˜ë¨¸ì§€ëŠ” í•©ê³„)
        if (isAverageMetric) {
          // DAUëŠ” í‰ê· ê°’ ê³„ì‚°
          targetAccumulated = filteredTargetData.reduce((sum, item) => {
            return sum + (item.value !== null ? Number(item.value) : 0);
          }, 0) / filteredTargetData.length;
        } else {
          // ë§¤ì¶œ, ë‹¤ìš´ë¡œë“œ, ìœ„ì‹œë¦¬ìŠ¤íŠ¸ëŠ” í•©ê³„ ê³„ì‚°
          targetAccumulated = filteredTargetData.reduce((sum, item) => {
            return sum + (item.value !== null ? Number(item.value) : 0);
          }, 0);
        }
        
        // ê¸°ê°„ ë‚´ ì¼í‰ê·  ê³„ì‚°
        targetAverage = filteredTargetData.reduce((sum, item) => {
          return sum + (item.value !== null ? Number(item.value) : 0);
        }, 0) / filteredTargetData.length;
        
        // ê¸°ê°„ ë‚´ ì¦ê°ë¥  ê³„ì‚° (ì„ íƒ ê¸°ê°„ì˜ ì²«ë‚ ê³¼ ë§ˆì§€ë§‰ë‚  ë¹„êµ)
        if (filteredTargetData.length >= 2) {
          const firstDayValue = filteredTargetData[0].value || 0;
          const lastDayValue = filteredTargetData[filteredTargetData.length - 1].value || 0;
          
          if (firstDayValue > 0) {
            const changeRate = ((lastDayValue - firstDayValue) / firstDayValue) * 100;
            const isPositive = changeRate >= 0;
            const sign = isPositive ? '+' : '';
            const badgeClass = isPositive ? 'bg-success' : 'bg-danger';
            document.getElementById('targetChangeRate').className = `badge rounded-pill ${badgeClass}`;
            document.getElementById('targetChangeRate').textContent = `${sign}${changeRate.toFixed(2)}%`;
          }
        }
      }
      
      // ì „ì²´ ë°ì´í„° í•©ê³„ ê³„ì‚°
      if (allGlobalData.length > 0) {
        if (isAverageMetric) {
          // DAUëŠ” ì „ì²´ ê¸°ê°„ì˜ í‰ê· 
          globalTotal = allGlobalData.reduce((sum, item) => {
            return sum + (item.value !== null ? Number(item.value) : 0);
          }, 0) / allGlobalData.length;
        } else {
          // ë§¤ì¶œ, ë‹¤ìš´ë¡œë“œ, ìœ„ì‹œë¦¬ìŠ¤íŠ¸ëŠ” ì „ì²´ í•©ê³„
          globalTotal = allGlobalData.reduce((sum, item) => {
            return sum + (item.value !== null ? Number(item.value) : 0);
          }, 0);
        }
      }
      
      if (allTargetData.length > 0) {
        if (isAverageMetric) {
          // DAUëŠ” ì „ì²´ ê¸°ê°„ì˜ í‰ê· 
          targetTotal = allTargetData.reduce((sum, item) => {
            return sum + (item.value !== null ? Number(item.value) : 0);
          }, 0) / allTargetData.length;
        } else {
          // ë§¤ì¶œ, ë‹¤ìš´ë¡œë“œ, ìœ„ì‹œë¦¬ìŠ¤íŠ¸ëŠ” ì „ì²´ í•©ê³„
          targetTotal = allTargetData.reduce((sum, item) => {
            return sum + (item.value !== null ? Number(item.value) : 0);
          }, 0);
        }
      }
      
      // ì§€í‘œì— ë”°ë¼ ë‹¨ìœ„ ì¶”ê°€
      let unit = '';
      if (currentMetric === 'revenue') {
        unit = ' ì›';
      } else if (currentMetric === 'downloads') {
        unit = ' íšŒ';
      } else if (currentMetric === 'dau') {
        unit = ' ëª…';
      } else if (currentMetric === 'wishlist') {
        unit = ' ê°œ';
      }
      
      // ê¸°ê°„ ë‚´ í•©ê³„ í‘œì‹œ
      document.getElementById('globalAccumulatedValue').textContent = Math.round(globalAccumulated).toLocaleString() + unit;
      document.getElementById('targetAccumulatedValue').textContent = Math.round(targetAccumulated).toLocaleString() + unit;
      
      // ê¸°ê°„ ë‚´ í‰ê·  í‘œì‹œ
      document.getElementById('globalAverageValue').textContent = Math.round(globalAverage).toLocaleString() + unit;
      document.getElementById('targetAverageValue').textContent = Math.round(targetAverage).toLocaleString() + unit;
      
      // ì „ì²´ ë°ì´í„° í•©ê³„ í‘œì‹œ
      document.getElementById('globalTotalValue').textContent = Math.round(globalTotal).toLocaleString() + unit;
      document.getElementById('targetTotalValue').textContent = Math.round(targetTotal).toLocaleString() + unit;
      
      console.log('ì°¨íŠ¸ ìƒì„± ì™„ë£Œ');
      console.log('ë°ì´í„° ê³„ì‚° ê²°ê³¼:', { 
        ê¸°ê°„ë‚´í•©ê³„: { ê¸€ë¡œë²Œ: globalAccumulated, ì§„ì¶œêµ­ê°€: targetAccumulated },
        ê¸°ê°„ë‚´í‰ê· : { ê¸€ë¡œë²Œ: globalAverage, ì§„ì¶œêµ­ê°€: targetAverage },
        ì „ì²´í•©ê³„: { ê¸€ë¡œë²Œ: globalTotal, ì§„ì¶œêµ­ê°€: targetTotal }
      });
      
    } catch (error) {
      console.error('ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
      document.getElementById('performanceChartContainer').innerHTML = `
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle me-2"></i> ì°¨íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}
        </div>
      `;
    }
  }
  
  // í•„í„° ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  document.querySelectorAll('input[name="metricRadio"]').forEach(radio => {
    radio.addEventListener('change', function() {
      currentMetric = this.value;
      console.log('ì§€í‘œ ë³€ê²½:', currentMetric);
      updatePerformanceChart();
    });
  });
  
  // ë‚ ì§œ í•„í„° ì ìš© ë²„íŠ¼
  document.getElementById('applyDateFilter').addEventListener('click', function() {
    console.log('ë‚ ì§œ í•„í„° ì ìš©:', document.getElementById('startDate').value, document.getElementById('endDate').value);
    updatePerformanceChart();
  });
  
  // ì´ˆê¸° ì°¨íŠ¸ ë Œë”ë§
  console.log('ì´ˆê¸° ì°¨íŠ¸ ë Œë”ë§ ì‹œì‘');
  updatePerformanceChart();
});

// ìš°ìˆ˜ê²Œì„ì‚¬ í† ê¸€ í•¨ìˆ˜
async function toggleExcellentCompany(phase) {
  try {
    // í˜„ì¬ ê²Œì„ì‚¬ì˜ ì²« ë²ˆì§¸ ê²Œì„ IDë¥¼ ê°€ì ¸ì˜´
    const gameId = '<%= games.length > 0 ? games[0].id : "" %>';
    if (!gameId) {
      alert('ê²Œì„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    // í˜„ì¬ ìƒíƒœ í™•ì¸
    const statusResponse = await fetch(`/points/excellent/${gameId}`);
    const statusResult = await statusResponse.json();
    
    if (!statusResult.success) {
      alert('ìš°ìˆ˜ê²Œì„ì‚¬ ìƒíƒœ ì¡°íšŒ ì˜¤ë¥˜: ' + statusResult.message);
      return;
    }
    
    // í˜„ì¬ í•´ë‹¹ ì°¨ìˆ˜ì˜ ìƒíƒœ í™•ì¸
    const currentStatus = statusResult.status[`is_excellent_${phase}`];
    const newStatus = !currentStatus;
    
    // í† ê¸€ ìš”ì²­
    const response = await fetch(`/points/excellent/${gameId}/${phase}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        isExcellent: newStatus
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      // ì„±ê³µì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ë°ì´í„° ì—…ë°ì´íŠ¸
      location.reload();
    } else {
      alert('ì˜¤ë¥˜: ' + result.message);
    }
  } catch (error) {
    alert('ìš°ìˆ˜ê²Œì„ì‚¬ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
  }
}

// í¬ì¸íŠ¸ ì‚¬ìš© í† ê¸€ í•¨ìˆ˜
async function togglePointUsage(switchElement) {
  const contractId = switchElement.dataset.contractId;
  const usePoints = switchElement.checked;
  
  try {
    switchElement.disabled = true;
    
    const response = await fetch(`/points/toggle/${contractId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        usePoints: usePoints
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      // ì„±ê³µì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ë°ì´í„° ì—…ë°ì´íŠ¸
      location.reload();
    } else {
      alert('ì˜¤ë¥˜: ' + result.message);
      // ì›ë˜ ìƒíƒœë¡œ ë˜ëŒë¦¬ê¸°
      switchElement.checked = !usePoints;
    }
  } catch (error) {
    alert('í¬ì¸íŠ¸ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    switchElement.checked = !usePoints;
  } finally {
    switchElement.disabled = false;
  }
}
</script> 