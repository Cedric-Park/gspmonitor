<div class="row mb-4">
  <div class="col-md-12">
    <div class="card shadow">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-0">í¬ì¸íŠ¸ í†µê³„ ëŒ€ì‹œë³´ë“œ</h5>
          <% if (typeof syncInfo !== 'undefined') { %>
            <div class="mt-1 small">
              <span class="badge bg-light text-dark me-2">
                <i class="bi bi-clock-history"></i> ë§ˆì§€ë§‰ ë™ê¸°í™”: <%= syncInfo.lastSync %>
              </span>
              <span class="badge bg-light text-dark">
                <i class="bi bi-hourglass-split"></i> ë‹¤ìŒ ë™ê¸°í™”ê¹Œì§€: <%= syncInfo.remainingMinutes %>ë¶„
              </span>
            </div>
          <% } %>
        </div>
        <div>
          <a href="/statistics/export-pdf" class="btn btn-light btn-sm me-2">
            <i class="bi bi-file-earmark-pdf"></i> PDF ë‚´ë³´ë‚´ê¸°
          </a>
          <% if (user && user.role === 'ì–´ë“œë¯¼') { %>
            <a href="/sync" class="btn btn-light btn-sm">ë°ì´í„° ë™ê¸°í™”</a>
          <% } %>
        </div>
      </div>
      <div class="card-body">
        <% if (typeof companyUsageStats !== 'undefined' && companyUsageStats.length > 0) { %>
          
          <% if (typeof companyRevenueStats !== 'undefined' && companyRevenueStats.length > 0) { %>
          <!-- ê¸°ê°„ ì„ íƒ í•„í„° -->
          <div class="mb-4">
            <div class="card shadow">
              <div class="card-header bg-light">
                <h5 class="mb-0">ê¸°ê°„ ì„ íƒ</h5>
              </div>
              <div class="card-body">
                <% if (typeof dateFilter !== 'undefined' && !dateFilter.isValid && dateFilter.error) { %>
                  <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong>ì˜¤ë¥˜:</strong> <%= dateFilter.error %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                <% } %>
                <form id="dateFilterForm" action="/statistics" method="GET" class="row g-3 align-items-end">
                  <div class="col-md-4">
                    <label for="start_date" class="form-label">ì‹œì‘ì¼</label>
                    <input type="date" class="form-control" id="start_date" name="start_date" value="<%= typeof dateFilter !== 'undefined' ? dateFilter.startDate : '' %>">
                  </div>
                  <div class="col-md-4">
                    <label for="end_date" class="form-label">ì¢…ë£Œì¼</label>
                    <input type="date" class="form-control" id="end_date" name="end_date" value="<%= typeof dateFilter !== 'undefined' ? dateFilter.endDate : '' %>">
                  </div>
                  <div class="col-md-4">
                    <button type="submit" class="btn btn-primary w-100">
                      <i class="bi bi-search me-1"></i> ì ìš©
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          
          <!-- ë§¤ì¶œ ê´€ë ¨ í•­ëª© ê·¸ë£¹ -->
          <div class="mb-5">
            <h5 class="mb-3 text-primary">ê²Œì„ì‚¬ ë§¤ì¶œ í˜„í™© 
              <% if (typeof dateFilter !== 'undefined' && dateFilter.startDate && dateFilter.endDate) { %>
                <small class="text-muted">(<%= dateFilter.startDate %> ~ <%= dateFilter.endDate %>)</small>
              <% } %>
            </h5>
            
            <!-- ê²Œì„ì‚¬ë³„ ëˆ„ì  ë§¤ì¶œ í˜„í™© ì¹´ë“œ -->
            <div class="row mb-4">
              <div class="col-md-4 mb-3">
                <div class="card text-white h-100" style="background-color: #6A5ACD;">
                  <div class="card-body text-center">
                    <h3 class="mb-1"><%= totalRevenue.toLocaleString() %> ì›</h3>
                    <small>ê²Œì„ì‚¬ ì´ ëˆ„ì  ë§¤ì¶œ</small>
                  </div>
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <div class="card text-white h-100" style="background-color: #5B9BD5;">
                  <div class="card-body text-center">
                    <h3 class="mb-1"><%= companyRevenueStats.reduce((sum, company) => sum + company.global_revenue, 0).toLocaleString() %> ì›</h3>
                    <small>ê¸€ë¡œë²Œ ë§¤ì¶œ</small>
                  </div>
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <div class="card text-white h-100" style="background-color: #ED7D31;">
                  <div class="card-body text-center">
                    <h3 class="mb-1"><%= companyRevenueStats.reduce((sum, company) => sum + company.domestic_revenue, 0).toLocaleString() %> ì›</h3>
                    <small>êµ­ë‚´ ë§¤ì¶œ</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- ê²Œì„ì‚¬ë³„ ëˆ„ì  ë§¤ì¶œ ì°¨íŠ¸ -->
            <div class="row mb-4">
              <div class="col-md-12">
                <div class="card shadow">
                  <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ê²Œì„ì‚¬ë³„ ëˆ„ì  ë§¤ì¶œ</h5>
                    <div class="d-flex align-items-center">
                      <div class="btn-group me-3" role="group">
                        <input type="radio" class="btn-check" name="revenueType" id="revenueTypeTotal" checked>
                        <label class="btn btn-outline-primary btn-sm" for="revenueTypeTotal">ì „ì²´ ë§¤ì¶œ</label>
                        
                        <input type="radio" class="btn-check" name="revenueType" id="revenueTypeGlobal">
                        <label class="btn btn-outline-primary btn-sm" for="revenueTypeGlobal">ê¸€ë¡œë²Œ ë§¤ì¶œ</label>
                        
                        <input type="radio" class="btn-check" name="revenueType" id="revenueTypeTarget">
                        <label class="btn btn-outline-primary btn-sm" for="revenueTypeTarget">ì§„ì¶œêµ­ê°€ ë§¤ì¶œ</label>
                        
                        <input type="radio" class="btn-check" name="revenueType" id="revenueTypeDomestic">
                        <label class="btn btn-outline-primary btn-sm" for="revenueTypeDomestic">êµ­ë‚´ ë§¤ì¶œ</label>
                      </div>
                      
                      <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="periodDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                          ë¹ ë¥¸ ê¸°ê°„ ì„ íƒ
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="periodDropdown">
                          <li><a class="dropdown-item period-select" href="#" data-period="1month">ìµœê·¼ 1ê°œì›”</a></li>
                          <li><a class="dropdown-item period-select" href="#" data-period="3month">ìµœê·¼ 3ê°œì›”</a></li>
                          <li><a class="dropdown-item period-select" href="#" data-period="6month">ìµœê·¼ 6ê°œì›”</a></li>
                          <li><a class="dropdown-item period-select" href="#" data-period="1year">ìµœê·¼ 1ë…„</a></li>
                          <li><hr class="dropdown-divider"></li>
                          <li><a class="dropdown-item period-select" href="#" data-period="all">ì „ì²´ ê¸°ê°„</a></li>
                        </ul>
                      </div>
                    </div>
                  </div>
                  <div class="card-body" style="height: 400px;">
                    <canvas id="revenueChart"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- ê²Œì„ì‚¬ë³„ ëˆ„ì  ë§¤ì¶œ ìƒì„¸ í…Œì´ë¸” -->
            <div class="row mb-4">
              <div class="col-md-12">
                <div class="card shadow">
                  <div class="card-header bg-light">
                    <h5 class="mb-0">ê²Œì„ì‚¬ë³„ ëˆ„ì  ë§¤ì¶œ ìƒì„¸</h5>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table table-hover" id="revenueTable">
                        <thead>
                          <tr>
                            <th>ê²Œì„ì‚¬</th>
                            <th id="revenueColumnHeader">ì´ ë§¤ì¶œ</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% companyRevenueStats.forEach(company => { %>
                            <tr>
                              <td><a href="/games/company/<%= encodeURIComponent(company.company_name) %>"><%= company.company_name %></a></td>
                              <td class="revenue-total"><strong><%= company.total_revenue.toLocaleString() %></strong></td>
                              <td class="revenue-global" style="display:none;"><%= company.global_revenue.toLocaleString() %></td>
                              <td class="revenue-domestic" style="display:none;"><%= company.domestic_revenue.toLocaleString() %></td>
                              <td class="revenue-target" style="display:none;"><%= (company.total_revenue - company.domestic_revenue).toLocaleString() %></td>
                            </tr>
                          <% }); %>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <% } %>

          <!-- í¬ì¸íŠ¸ ê´€ë ¨ í•­ëª© ê·¸ë£¹ -->
          <div class="mb-4">
            <h5 class="mb-3 text-primary">í¬ì¸íŠ¸ ì‚¬ìš© í˜„í™©</h5>
            
            <!-- í¬ì¸íŠ¸ í˜„í™© ì¹´ë“œ -->
            <div class="row mb-4">
              <div class="col-md-2 mb-3">
                <div class="card text-white h-100" style="background-color: #4A568D;">
                  <div class="card-body text-center">
                    <h3 class="mb-1"><%= companyUsageStats.reduce((sum, company) => sum + company.total_points, 0).toLocaleString() %> P</h3>
                    <small>ì´ ë°°ì • í¬ì¸íŠ¸</small>
                  </div>
                </div>
              </div>
              <div class="col-md-2 mb-3">
                <div class="card text-white h-100" style="background-color: #6C757D;">
                  <div class="card-body text-center">
                    <h3 class="mb-1"><%= companyUsageStats.reduce((sum, company) => sum + (company.base_points || 0), 0).toLocaleString() %> P</h3>
                    <small>ê¸°ë³¸ í¬ì¸íŠ¸</small>
                  </div>
                </div>
              </div>
              <div class="col-md-2 mb-3">
                <div class="card text-white h-100" style="background-color: #17A2B8;">
                  <div class="card-body text-center">
                    <h3 class="mb-1"><%= companyUsageStats.reduce((sum, company) => sum + (company.self_points || 0), 0).toLocaleString() %> P</h3>
                    <small>ìë¶€ë‹´ í¬ì¸íŠ¸</small>
                  </div>
                </div>
              </div>
              <div class="col-md-2 mb-3">
                <div class="card text-white h-100" style="background-color: #FFC107;">
                  <div class="card-body text-center">
                    <h3 class="mb-1 text-dark"><%= companyUsageStats.reduce((sum, company) => sum + (company.excellent_points || 0), 0).toLocaleString() %> P</h3>
                    <small class="text-dark">ìš°ìˆ˜ í¬ì¸íŠ¸</small>
                  </div>
                </div>
              </div>
              <div class="col-md-2 mb-3">
                <div class="card text-white h-100" style="background-color: #B85450;">
                  <div class="card-body text-center">
                    <h3 class="mb-1"><%= companyUsageStats.reduce((sum, company) => sum + company.used_points, 0).toLocaleString() %> P</h3>
                    <small>ì´ ì‚¬ìš© í¬ì¸íŠ¸</small>
                  </div>
                </div>
              </div>
              <div class="col-md-2 mb-3">
                <div class="card text-white h-100" style="background-color: #5A8A5A;">
                  <div class="card-body text-center">
                    <h3 class="mb-1"><%= companyUsageStats.reduce((sum, company) => sum + (company.total_points - company.used_points), 0).toLocaleString() %> P</h3>
                    <small>ì´ ì”ì—¬ í¬ì¸íŠ¸</small>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ì‚¬ìš©ë¥  ì¹´ë“œ -->
            <div class="row mb-4">
              <div class="col-md-12">
                <div class="card text-white" style="background-color: #C8A869;">
                  <div class="card-body text-center">
                    <% 
                      const totalAlloc = companyUsageStats.reduce((sum, company) => sum + company.total_points, 0);
                      const totalUsed = companyUsageStats.reduce((sum, company) => sum + company.used_points, 0);
                      const usageRate = totalAlloc > 0 ? (totalUsed / totalAlloc * 100) : 0;
                    %>
                    <h2 class="mb-1"><%= usageRate.toFixed(1) %>%</h2>
                    <h5>ì „ì²´ ì‚¬ìš©ë¥ </h5>
                  </div>
                </div>
              </div>
            </div>

            <!-- ì„œë¹„ìŠ¤ ë¶€ë¬¸ë³„ í¬ì¸íŠ¸ ì‚¬ìš© í†µê³„ -->
            <div class="row mb-4">
              <div class="col-md-12">
                <div class="card shadow h-100">
                  <div class="card-header bg-success text-white">
                    <h5 class="mb-0">ì„œë¹„ìŠ¤ ë¶€ë¬¸ë³„ í¬ì¸íŠ¸ ì‚¬ìš© ë¶„ì„</h5>
                  </div>
                  <div class="card-body d-flex align-items-center justify-content-center" style="height: 300px;">
                    <canvas id="serviceCategoryChart"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- ê²Œì„ì‚¬ë³„ í¬ì¸íŠ¸ ì‚¬ìš©ë¥  ì°¨íŠ¸ -->
            <div class="row mb-4">
              <div class="col-md-12">
                <div class="card shadow">
                  <div class="card-header bg-light">
                    <h5 class="mb-0">ê²Œì„ì‚¬ë³„ í¬ì¸íŠ¸ ì‚¬ìš©ë¥ </h5>
                  </div>
                  <div class="card-body" style="height: 400px;">
                    <canvas id="pointsChart"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- í¬ì¸íŠ¸ ë°ì´í„° í…Œì´ë¸” -->
            <div class="row">
              <div class="col-md-6">
                <div class="card shadow">
                  <div class="card-header bg-light">
                    <h5 class="mb-0">ê²Œì„ì‚¬ë³„ í¬ì¸íŠ¸ ì‚¬ìš©ë¥  ìƒì„¸</h5>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table table-hover">
                        <thead>
                          <tr>
                            <th>ê²Œì„ì‚¬</th>
                            <th>ê¸°ë³¸</th>
                            <th>ìë¶€ë‹´</th>
                            <th>ìš°ìˆ˜</th>
                            <th>ì´ í¬ì¸íŠ¸</th>
                            <th>ì‚¬ìš©ëŸ‰</th>
                            <th>ì‚¬ìš©ë¥ </th>
                          </tr>
                        </thead>
                        <tbody>
                          <% companyUsageStats.forEach(company => { %>
                            <tr>
                              <td>
                                <a href="/games/company/<%= encodeURIComponent(company.company_name) %>">
                                  <%= company.company_name %>
                                </a>
                                <!-- ìš°ìˆ˜ê²Œì„ì‚¬ ì•„ì´ì½˜ í‘œì‹œ -->
                                <% if (company.excellent_points > 0) { %>
                                  <span class="ms-2">
                                    <% if (company.excellent_points >= 300000000) { %>ğŸ¥‡ğŸ¥ˆğŸ¥‰<% } 
                                       else if (company.excellent_points >= 200000000) { %>ğŸ¥‡ğŸ¥ˆ<% } 
                                       else if (company.excellent_points >= 100000000) { %>ğŸ¥‡<% } %>
                                  </span>
                                <% } %>
                              </td>
                              <td><%= (company.base_points || 0).toLocaleString() %></td>
                              <td><%= (company.self_points || 0).toLocaleString() %></td>
                              <td class="text-warning fw-bold"><%= (company.excellent_points || 0).toLocaleString() %></td>
                              <td class="fw-bold"><%= company.total_points.toLocaleString() %></td>
                              <td><%= company.used_points.toLocaleString() %></td>
                              <td><span class="badge bg-<%= company.usage_rate >= 80 ? 'danger' : (company.usage_rate >= 50 ? 'warning' : 'success') %>">
                                <%= company.usage_rate.toFixed(1) %>%
                              </span></td>
                            </tr>
                          <% }); %>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="card shadow">
                  <div class="card-header bg-light">
                    <h5 class="mb-0">ì„œë¹„ìŠ¤ ë¶€ë¬¸ë³„ í¬ì¸íŠ¸ ì‚¬ìš© ìƒì„¸</h5>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table table-hover">
                        <thead>
                          <tr>
                            <th>ì„œë¹„ìŠ¤ ë¶€ë¬¸</th>
                            <th>ì‚¬ìš©ëŸ‰</th>
                            <th>ë¹„ìœ¨</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% serviceCategoryStats.categories.forEach(category => { %>
                            <tr>
                              <td><%= category.category %></td>
                              <td><%= category.amount.toLocaleString() %></td>
                              <td><span class="badge bg-primary"><%= category.percentage.toFixed(1) %>%</span></td>
                            </tr>
                          <% }); %>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% } else { %>
          <div class="alert alert-warning">
            <p><i class="bi bi-exclamation-triangle-fill me-2"></i> í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <p>'ë°ì´í„° ë™ê¸°í™”' ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìµœì‹  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì„¸ìš”.</p>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<script>
  // ë°ì´í„° ì¤€ë¹„
  <% if (typeof companyUsageStats !== 'undefined' && companyUsageStats.length > 0) { %>
    // ê²Œì„ì‚¬ë³„ í¬ì¸íŠ¸ ì‚¬ìš©ë¥  ì°¨íŠ¸ ë°ì´í„°
    const companies = [<%- companyUsageStats.map(c => `'${c.company_name}'`).join(',') %>];
    const totalPoints = [<%- companyUsageStats.map(c => c.total_points).join(',') %>];
    const usedPoints = [<%- companyUsageStats.map(c => c.used_points).join(',') %>];
    const remainingPoints = [<%- companyUsageStats.map(c => c.total_points - c.used_points).join(',') %>];
    
    // ì„œë¹„ìŠ¤ ë¶€ë¬¸ë³„ í¬ì¸íŠ¸ ì‚¬ìš© ì°¨íŠ¸ ë°ì´í„°
    const serviceCategories = [<%- serviceCategoryStats.categories.map(c => `'${c.category}'`).join(',') %>];
    const categoryAmounts = [<%- serviceCategoryStats.categories.map(c => c.amount).join(',') %>];
    const categoryPercentages = [<%- serviceCategoryStats.categories.map(c => c.percentage).join(',') %>];
    
    <% if (typeof companyRevenueStats !== 'undefined' && companyRevenueStats.length > 0) { %>
    // ê²Œì„ì‚¬ë³„ ëˆ„ì  ë§¤ì¶œ ì°¨íŠ¸ ë°ì´í„°
    const revenueCompanies = [<%- companyRevenueStats.map(c => `'${c.company_name}'`).join(',') %>];
    const globalRevenues = [<%- companyRevenueStats.map(c => c.global_revenue).join(',') %>];
    const domesticRevenues = [<%- companyRevenueStats.map(c => c.domestic_revenue).join(',') %>];
    const totalRevenues = [<%- companyRevenueStats.map(c => c.total_revenue).join(',') %>];
    
    // ì§„ì¶œêµ­ê°€ ë§¤ì¶œ ê³„ì‚° (ì „ì²´ - êµ­ë‚´)
    const targetRevenues = totalRevenues.map((total, i) => total - domesticRevenues[i]);
    <% } %>
    
    // ìƒ‰ìƒ ì •ì˜
    const categoryColors = [
      'rgba(75, 192, 192, 0.7)',
      'rgba(54, 162, 235, 0.7)',
      'rgba(255, 206, 86, 0.7)',
      'rgba(255, 99, 132, 0.7)',
      'rgba(153, 102, 255, 0.7)',
    ];
    
    // PDF ë‚´ë³´ë‚´ê¸° ê°ì§€
    const isPdfExport = <%= typeof exportToPdf !== 'undefined' && exportToPdf ? 'true' : 'false' %>;
    
    <% if (typeof companyRevenueStats !== 'undefined' && companyRevenueStats.length > 0) { %>
    // ê²Œì„ì‚¬ë³„ ëˆ„ì  ë§¤ì¶œ ì°¨íŠ¸
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    let revenueChart = new Chart(revenueCtx, {
      type: 'bar',
      data: {
        labels: revenueCompanies,
        datasets: [
          {
            label: 'ì´ ë§¤ì¶œ',
            data: totalRevenues,
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: isPdfExport ? 0 : 1000 // PDF ë‚´ë³´ë‚´ê¸° ì‹œ ì• ë‹ˆë©”ì´ì…˜ ë¹„í™œì„±í™”
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.dataset.label || '';
                const value = context.raw.toLocaleString();
                return `${label}: ${value} ì›`;
              }
            }
          }
        },
        scales: {
          x: {
            stacked: false
          },
          y: {
            stacked: false,
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString();
              }
            }
          }
        }
      }
    });
    
    // ë¼ë””ì˜¤ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    document.getElementById('revenueTypeTotal').addEventListener('change', function() {
      if(this.checked) {
        updateRevenueDisplay('total');
      }
    });
    
    document.getElementById('revenueTypeGlobal').addEventListener('change', function() {
      if(this.checked) {
        updateRevenueDisplay('global');
      }
    });
    
    document.getElementById('revenueTypeTarget').addEventListener('change', function() {
      if(this.checked) {
        updateRevenueDisplay('target');
      }
    });
    
    document.getElementById('revenueTypeDomestic').addEventListener('change', function() {
      if(this.checked) {
        updateRevenueDisplay('domestic');
      }
    });
    
    // ë§¤ì¶œ ë°ì´í„° í‘œì‹œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateRevenueDisplay(type) {
      // 1. ë°ì´í„° ë° ìƒ‰ìƒ ì„¤ì •
      let data, label, color;
      
      switch(type) {
        case 'global':
          data = globalRevenues;
          label = 'ê¸€ë¡œë²Œ ë§¤ì¶œ';
          color = 'rgba(54, 162, 235, 0.7)';
          break;
        case 'target':
          data = targetRevenues;
          label = 'ì§„ì¶œêµ­ê°€ ë§¤ì¶œ';
          color = 'rgba(75, 192, 192, 0.7)';
          break;
        case 'domestic':
          data = domesticRevenues;
          label = 'êµ­ë‚´ ë§¤ì¶œ';
          color = 'rgba(255, 99, 132, 0.7)';
          break;
        default: // total
          data = totalRevenues;
          label = 'ì´ ë§¤ì¶œ';
          color = 'rgba(54, 162, 235, 0.7)';
      }
      
      // 2. ë°ì´í„° ì •ë ¬
      const sortedData = sortByRevenue(revenueCompanies, data);
      
      // 3. ì°¨íŠ¸ ì—…ë°ì´íŠ¸
      updateRevenueChart(label, color, sortedData);
      
      // 4. í…Œì´ë¸” ì—…ë°ì´íŠ¸
      updateRevenueTable(type, sortedData.indices);
    }
    
    // ë§¤ì¶œ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•˜ëŠ” í•¨ìˆ˜
    function sortByRevenue(companies, revenues) {
      // íšŒì‚¬ëª…ê³¼ ë§¤ì¶œì„ í•¨ê»˜ ì €ì¥
      const combined = [];
      for (let i = 0; i < companies.length; i++) {
        combined.push({
          company: companies[i],
          revenue: revenues[i],
          originalIndex: i
        });
      }
      
      // ë§¤ì¶œ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
      combined.sort((a, b) => b.revenue - a.revenue);
      
      // ì •ë ¬ëœ ê²°ê³¼ ë°˜í™˜
      const labels = [];
      const values = [];
      const indices = [];
      
      for (let i = 0; i < combined.length; i++) {
        labels.push(combined[i].company);
        values.push(combined[i].revenue);
        indices.push(combined[i].originalIndex);
      }
      
      return {
        labels: labels,
        values: values,
        indices: indices
      };
    }
    
    // ì°¨íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateRevenueChart(label, color, sortedData) {
      revenueChart.data.labels = sortedData.labels;
      revenueChart.data.datasets = [{
        label: label,
        data: sortedData.values,
        backgroundColor: color,
        borderColor: color.replace('0.7', '1'),
        borderWidth: 1
      }];
      
      revenueChart.update();
    }
    
    // í…Œì´ë¸” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateRevenueTable(type, sortedIndices) {
      // í—¤ë” ì—…ë°ì´íŠ¸
      const headerText = {
        'total': 'ì´ ë§¤ì¶œ',
        'global': 'ê¸€ë¡œë²Œ ë§¤ì¶œ',
        'target': 'ì§„ì¶œêµ­ê°€ ë§¤ì¶œ',
        'domestic': 'êµ­ë‚´ ë§¤ì¶œ'
      };
      
      document.getElementById('revenueColumnHeader').textContent = headerText[type];
      
      // í…Œì´ë¸” ì™„ì „íˆ ì¬êµ¬ì„±
      const table = document.getElementById('revenueTable');
      const tbody = table.querySelector('tbody');
      
      // ì›ë³¸ ë°ì´í„° ì €ì¥
      const originalData = [];
      for (let i = 0; i < revenueCompanies.length; i++) {
        originalData.push({
          company: revenueCompanies[i],
          companyUrl: encodeURIComponent(revenueCompanies[i]),
          total: totalRevenues[i],
          global: globalRevenues[i],
          domestic: domesticRevenues[i],
          target: totalRevenues[i] - domesticRevenues[i]
        });
      }
      
      // ì •ë ¬ëœ ë°ì´í„° ìƒì„±
      const sortedData = [];
      for (let i = 0; i < sortedIndices.length; i++) {
        sortedData.push(originalData[sortedIndices[i]]);
      }
      
      // í…Œì´ë¸” ë‚´ìš© ë¹„ìš°ê¸°
      tbody.innerHTML = '';
      
      // ì •ë ¬ëœ ë°ì´í„°ë¡œ í…Œì´ë¸” ìƒˆë¡œ êµ¬ì„±
      for (let i = 0; i < sortedData.length; i++) {
        const row = document.createElement('tr');
        
        // íšŒì‚¬ëª… ì…€
        const companyCell = document.createElement('td');
        const companyLink = document.createElement('a');
        companyLink.href = '/games/company/' + sortedData[i].companyUrl;
        companyLink.textContent = sortedData[i].company;
        companyCell.appendChild(companyLink);
        row.appendChild(companyCell);
        
        // ì´ ë§¤ì¶œ ì…€
        const totalCell = document.createElement('td');
        totalCell.className = 'revenue-total';
        totalCell.innerHTML = '<strong>' + sortedData[i].total.toLocaleString() + '</strong>';
        if (type !== 'total') totalCell.style.display = 'none';
        row.appendChild(totalCell);
        
        // ê¸€ë¡œë²Œ ë§¤ì¶œ ì…€
        const globalCell = document.createElement('td');
        globalCell.className = 'revenue-global';
        globalCell.textContent = sortedData[i].global.toLocaleString();
        if (type !== 'global') globalCell.style.display = 'none';
        row.appendChild(globalCell);
        
        // êµ­ë‚´ ë§¤ì¶œ ì…€
        const domesticCell = document.createElement('td');
        domesticCell.className = 'revenue-domestic';
        domesticCell.textContent = sortedData[i].domestic.toLocaleString();
        if (type !== 'domestic') domesticCell.style.display = 'none';
        row.appendChild(domesticCell);
        
        // ì§„ì¶œêµ­ê°€ ë§¤ì¶œ ì…€
        const targetCell = document.createElement('td');
        targetCell.className = 'revenue-target';
        targetCell.textContent = sortedData[i].target.toLocaleString();
        if (type !== 'target') targetCell.style.display = 'none';
        row.appendChild(targetCell);
        
        // í–‰ ì¶”ê°€
        tbody.appendChild(row);
      }
    }
    
    // ì´ˆê¸° ì°¨íŠ¸ ì„¤ì • (í˜ì´ì§€ ë¡œë“œ ì‹œ)
    updateRevenueDisplay('total');
    <% } %>
    
    // ê²Œì„ì‚¬ë³„ í¬ì¸íŠ¸ ì‚¬ìš©ë¥  ì°¨íŠ¸
    const pointsCtx = document.getElementById('pointsChart').getContext('2d');
    const pointsChart = new Chart(pointsCtx, {
      type: 'bar',
      data: {
        labels: companies,
        datasets: [
          {
            label: 'ì‚¬ìš© í¬ì¸íŠ¸',
            data: usedPoints,
            backgroundColor: 'rgba(75, 192, 192, 0.7)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          },
          {
            label: 'ë¯¸ì‚¬ìš© í¬ì¸íŠ¸',
            data: remainingPoints,
            backgroundColor: 'rgba(220, 220, 220, 0.7)',
            borderColor: 'rgba(220, 220, 220, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: isPdfExport ? 0 : 1000 // PDF ë‚´ë³´ë‚´ê¸° ì‹œ ì• ë‹ˆë©”ì´ì…˜ ë¹„í™œì„±í™”
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.dataset.label || '';
                const value = context.raw.toLocaleString();
                const datasetIndex = context.datasetIndex;
                const index = context.dataIndex;
                
                let percentage = 0;
                if (datasetIndex === 0) { // ì‚¬ìš© í¬ì¸íŠ¸
                  percentage = (usedPoints[index] / totalPoints[index] * 100).toFixed(1);
                } else { // ë¯¸ì‚¬ìš© í¬ì¸íŠ¸
                  percentage = (remainingPoints[index] / totalPoints[index] * 100).toFixed(1);
                }
                
                return `${label}: ${value} (${percentage}%)`;
              }
            }
          }
        },
        scales: {
          x: {
            stacked: true
          },
          y: {
            stacked: true,
            beginAtZero: true
          }
        }
      }
    });

    // ì„œë¹„ìŠ¤ ë¶€ë¬¸ë³„ í¬ì¸íŠ¸ ì‚¬ìš© íŒŒì´ ì°¨íŠ¸
    const serviceCategoryCtx = document.getElementById('serviceCategoryChart').getContext('2d');
    const serviceCategoryChart = new Chart(serviceCategoryCtx, {
      type: 'doughnut',
      data: {
        labels: serviceCategories,
        datasets: [{
          data: categoryAmounts,
          backgroundColor: categoryColors,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: isPdfExport ? 0 : 1000 // PDF ë‚´ë³´ë‚´ê¸° ì‹œ ì• ë‹ˆë©”ì´ì…˜ ë¹„í™œì„±í™”
        },
        plugins: {
          legend: {
            position: 'bottom'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.raw.toLocaleString();
                const percentage = categoryPercentages[context.dataIndex].toFixed(1);
                return `${label}: ${value} P (${percentage}%)`;
              }
            }
          }
        }
      }
    });
    
    // PDF ë‚´ë³´ë‚´ê¸°ë¥¼ ìœ„í•œ ì°¨íŠ¸ ë Œë”ë§ ì™„ë£Œ ì´ë²¤íŠ¸
    if (isPdfExport) {
      // ëª¨ë“  ì°¨íŠ¸ê°€ ë Œë”ë§ ì™„ë£Œë˜ì—ˆìŒì„ ì•Œë¦¬ëŠ” ì´ë²¤íŠ¸ ë°œìƒ
      window.addEventListener('load', function() {
        // ì°¨íŠ¸ ë Œë”ë§ ì™„ë£Œ í›„ PDF ë Œë”ë§ì´ ê°€ëŠ¥í•˜ë„ë¡ ì‹ í˜¸ ì „ì†¡
        document.dispatchEvent(new Event('charts-rendered'));
      });
    }
    
    // ë¹ ë¥¸ ê¸°ê°„ ì„ íƒ ì´ë²¤íŠ¸ ì²˜ë¦¬
    document.addEventListener('DOMContentLoaded', function() {
      // ë¹ ë¥¸ ê¸°ê°„ ì„ íƒ ë“œë¡­ë‹¤ìš´ í•­ëª© í´ë¦­ ì´ë²¤íŠ¸
      document.querySelectorAll('.period-select').forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          
          const period = this.getAttribute('data-period');
          const today = new Date();
          let startDate = new Date();
          
          // ê¸°ê°„ì— ë”°ë¥¸ ì‹œì‘ì¼ ì„¤ì •
          switch(period) {
            case '1month':
              startDate.setMonth(today.getMonth() - 1);
              break;
            case '3month':
              startDate.setMonth(today.getMonth() - 3);
              break;
            case '6month':
              startDate.setMonth(today.getMonth() - 6);
              break;
            case '1year':
              startDate.setFullYear(today.getFullYear() - 1);
              break;
            case 'all':
              // ì „ì²´ ê¸°ê°„ì€ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ë¹„ì›Œì„œ ì „ì†¡
              document.getElementById('start_date').value = '';
              document.getElementById('end_date').value = '';
              document.getElementById('dateFilterForm').submit();
              return;
          }
          
          // ë‚ ì§œ í˜•ì‹ì„ YYYY-MM-DDë¡œ ë³€í™˜
          const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
          };
          
          // í¼ì— ë‚ ì§œ ì„¤ì • í›„ ì œì¶œ
          document.getElementById('start_date').value = formatDate(startDate);
          document.getElementById('end_date').value = formatDate(today);
          document.getElementById('dateFilterForm').submit();
        });
      });
    });
  <% } %>
</script> 